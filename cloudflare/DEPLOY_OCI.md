# Cloudflare Worker + OCI Storage éƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—èªªæ˜å¦‚ä½•éƒ¨ç½² Cloudflare Worker ä¾†è‡ªå‹•çˆ¬å–å°ä¸­å¸‚å»ºç…§è³‡æ–™ï¼Œä¸¦å„²å­˜åˆ° OCI Object Storageã€‚

## æ¶æ§‹å„ªå‹¢

- â˜ï¸ **ç„¡ä¼ºæœå™¨æ¶æ§‹**: ä½¿ç”¨ Cloudflare Workersï¼Œç„¡éœ€ç¶­è­·ä¼ºæœå™¨
- ğŸŒ **å…¨çƒç¶²è·¯**: åˆ©ç”¨ Cloudflare çš„å…¨çƒç¯€é»
- ğŸ’¾ **OCI å„²å­˜**: è³‡æ–™å„²å­˜åœ¨ä½ ç¾æœ‰çš„ OCI Object Storage
- â° **è‡ªå‹•æ’ç¨‹**: æ¯æ—¥å‡Œæ™¨ 3:00 è‡ªå‹•åŸ·è¡Œ
- ğŸ’° **æˆæœ¬æ•ˆç›Š**: Cloudflare å…è²»æ–¹æ¡ˆå³å¯æ»¿è¶³éœ€æ±‚

## å‰ç½®æº–å‚™

### 1. OCI è¨­å®š

åœ¨ OCI æ§åˆ¶å°å»ºç«‹é é©—è­‰è«‹æ±‚ï¼ˆPre-Authenticated Requestï¼‰ï¼š

```bash
# ç™»å…¥ OCI æ§åˆ¶å°
# å‰å¾€ Object Storage > ä½ çš„ Bucket
# å»ºç«‹é é©—è­‰è«‹æ±‚ï¼Œæ¬Šé™è¨­ç‚ºã€Œè®€å–ç‰©ä»¶ã€å’Œã€Œå¯«å…¥ç‰©ä»¶ã€
# è¤‡è£½ç”¢ç”Ÿçš„ URL ä¸­çš„é‡‘é‘°éƒ¨åˆ†
```

### 2. å®‰è£ Wrangler CLI

```bash
npm install -g wrangler
wrangler login
```

## éƒ¨ç½²æ­¥é©Ÿ

### 1. è¤‡è£½å°ˆæ¡ˆ

```bash
cd cloudflare
npm install
```

### 2. è¨­å®šç’°å¢ƒè®Šæ•¸

ç·¨è¼¯ `wrangler.toml`ï¼Œæ›´æ–° OCI é é©—è­‰è«‹æ±‚é‡‘é‘°ï¼š

```toml
[vars]
# ... å…¶ä»–è®Šæ•¸ä¿æŒä¸è®Š

# æ–°å¢é€™è¡Œ
OCI_PREAUTH_KEY = "ä½ çš„é é©—è­‰è«‹æ±‚é‡‘é‘°"
```

### 3. éƒ¨ç½² Worker

```bash
npm run deploy
```

éƒ¨ç½²æˆåŠŸå¾Œæœƒé¡¯ç¤ºä½ çš„ Worker URLï¼š
```
https://taichung-permits-crawler.YOUR-SUBDOMAIN.workers.dev
```

### 4. æ¸¬è©¦

è¨ªå•ä½ çš„ Worker URLï¼Œæ‡‰è©²æœƒçœ‹åˆ°ç›£æ§ä»‹é¢ã€‚

æ¸¬è©¦å–®ä¸€çˆ¬å–ï¼š
```
https://your-worker-url/api/test?year=114&seq=1
```

### 5. è¨­å®š Cronï¼ˆå¯é¸ï¼‰

å¦‚æœè¦èª¿æ•´åŸ·è¡Œæ™‚é–“ï¼Œç·¨è¼¯ `wrangler.toml`ï¼š

```toml
[triggers]
crons = ["0 19 * * *"]  # UTC 19:00 = å°ç£æ™‚é–“å‡Œæ™¨ 3:00
```

## æ‰‹å‹•è§¸ç™¼

åœ¨ç›£æ§ä»‹é¢é»æ“Šã€Œæ‰‹å‹•è§¸ç™¼çˆ¬èŸ²ã€æŒ‰éˆ•ï¼Œæˆ–ä½¿ç”¨ APIï¼š

```bash
curl -X POST https://your-worker-url/api/trigger
```

## ç›£æ§

### æŸ¥çœ‹å³æ™‚æ—¥èªŒ

```bash
npm run tail
```

### æŸ¥çœ‹çˆ¬èŸ²é€²åº¦

è¨ªå•ç›£æ§ä»‹é¢æˆ– APIï¼š
```
https://your-worker-url/api/status
```

## æ³¨æ„äº‹é …

1. **åŸ·è¡Œé™åˆ¶**: Cloudflare Workers æœ‰åŸ·è¡Œæ™‚é–“é™åˆ¶ï¼ˆCPU æ™‚é–“ 10ms-50msï¼‰ï¼Œæ‰€ä»¥æ¯æ¬¡æœ€å¤šçˆ¬å– 50 ç­†è³‡æ–™
2. **è«‹æ±‚é™åˆ¶**: å…è²»æ–¹æ¡ˆæ¯æ—¥ 100,000 æ¬¡è«‹æ±‚ï¼Œå°çˆ¬èŸ²ä¾†èªªç¶½ç¶½æœ‰é¤˜
3. **è³‡æ–™åŒæ­¥**: çˆ¬å–çš„è³‡æ–™æœƒå³æ™‚åŒæ­¥åˆ° OCI Object Storage

## æ•…éšœæ’é™¤

### é é©—è­‰è«‹æ±‚å¤±æ•—

- æª¢æŸ¥é é©—è­‰è«‹æ±‚æ˜¯å¦éæœŸ
- ç¢ºèªæ¬Šé™åŒ…å«è®€å–å’Œå¯«å…¥
- ç¢ºèª bucket åç¨±å’Œ namespace æ­£ç¢º

### çˆ¬èŸ²åŸ·è¡Œå¤±æ•—

- æŸ¥çœ‹ Worker æ—¥èªŒï¼š`npm run tail`
- æª¢æŸ¥ç›®æ¨™ç¶²ç«™æ˜¯å¦æ­£å¸¸
- èª¿æ•´å»¶é²æ™‚é–“ï¼ˆREQUEST_DELAY_MSï¼‰

### è³‡æ–™æœªæ›´æ–°

- æª¢æŸ¥ OCI Object Storage ä¸­çš„æª”æ¡ˆ
- ç¢ºèª permits.json æœ‰æ­£ç¢ºçš„å¯«å…¥æ¬Šé™
- æŸ¥çœ‹çˆ¬èŸ²è¨˜éŒ„ï¼ˆcrawl-logs.jsonï¼‰

## æˆæœ¬é ä¼°

Cloudflare Workers å…è²»æ–¹æ¡ˆï¼š
- æ¯æ—¥ 100,000 æ¬¡è«‹æ±‚
- æ¯æ¬¡è«‹æ±‚ 10ms CPU æ™‚é–“

å°æ–¼æ¯æ—¥çˆ¬å– 50-100 ç­†è³‡æ–™çš„éœ€æ±‚ï¼Œå…è²»æ–¹æ¡ˆå®Œå…¨è¶³å¤ ã€‚

## å¾ŒçºŒå„ªåŒ–

1. **å¢åŠ é‡è©¦æ©Ÿåˆ¶**: å°å¤±æ•—çš„çˆ¬å–é€²è¡Œé‡è©¦
2. **é€šçŸ¥åŠŸèƒ½**: çˆ¬å–å®Œæˆå¾Œç™¼é€é€šçŸ¥
3. **è³‡æ–™é©—è­‰**: å¢åŠ è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥
4. **æ•ˆèƒ½å„ªåŒ–**: æ‰¹æ¬¡è™•ç†æ¸›å°‘ API å‘¼å«

## ç›¸é—œé€£çµ

- [Cloudflare Workers æ–‡ä»¶](https://developers.cloudflare.com/workers/)
- [Wrangler CLI æ–‡ä»¶](https://developers.cloudflare.com/workers/wrangler/)
- [OCI Object Storage æ–‡ä»¶](https://docs.oracle.com/en-us/iaas/Content/Object/home.htm)