<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂØ∂‰Ω≥Ê©üÊßãÂª∫ÁÖßÁØ©ÈÅ∏Á≥ªÁµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            font-size: 28px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .permits-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .filter-header h3 {
            color: #2c3e50;
            font-size: 18px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #229954;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .company-manager {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .company-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .company-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .company-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
        }
        
        .company-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: #f8f9fa;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .company-item:hover {
            background-color: #e9ecef;
        }
        
        .company-name {
            font-size: 14px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .stats-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            text-align: center;
            padding: 15px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .permits-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .permits-table th,
        .permits-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .permits-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .permits-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .search-box {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .checkbox-item {
            margin-bottom: 8px;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .checkbox-item label {
            cursor: pointer;
            font-size: 14px;
        }
        
        .filter-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üè¢ ÂØ∂‰Ω≥Ê©üÊßãÂª∫ÁÖßÁØ©ÈÅ∏Á≥ªÁµ±</h1>
        </div>
    </header>
    
    <div class="container">
        <div class="main-content">
            <div class="sidebar">
                <div class="filter-section">
                    <div class="filter-header">
                        <h3>ÁØ©ÈÅ∏Ê¢ù‰ª∂</h3>
                        <input type="checkbox" id="filterToggle" checked>
                    </div>
                    
                    <div class="filter-controls">
                        <button class="btn btn-primary btn-small" onclick="selectAll()">ÂÖ®ÈÅ∏</button>
                        <button class="btn btn-primary btn-small" onclick="deselectAll()">ÂÖ®‰∏çÈÅ∏</button>
                    </div>
                    
                    <input type="text" class="search-box" id="companySearch" placeholder="ÊêúÂ∞ãÂÖ¨Âè∏ÂêçÁ®±...">
                    
                    <button class="btn btn-success" style="width: 100%; margin-bottom: 15px;" onclick="applyFilter()">
                        Â•óÁî®ÁØ©ÈÅ∏
                    </button>
                </div>
                
                <div class="company-manager">
                    <h3 style="margin-bottom: 15px;">ÂÖ¨Âè∏ÁÆ°ÁêÜ</h3>
                    <div class="company-input-group">
                        <input type="text" class="company-input" id="newCompany" placeholder="Ëº∏ÂÖ•ÂÖ¨Âè∏ÂêçÁ®±">
                        <button class="btn btn-primary" onclick="addCompany()">Êñ∞Â¢û</button>
                    </div>
                    
                    <div class="company-list" id="companyList">
                        <!-- ÂãïÊÖãËºâÂÖ•ÂÖ¨Âè∏Ê∏ÖÂñÆ -->
                    </div>
                </div>
            </div>
            
            <div class="permits-section">
                <div class="stats-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalCompanies">0</div>
                            <div class="stat-label">ÂØ∂‰Ω≥Ê©üÊßãÂÖ¨Âè∏Êï∏</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalPermits">0</div>
                            <div class="stat-label">Âª∫ÁÖßÁ∏ΩÊï∏</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="filteredPermits">0</div>
                            <div class="stat-label">ÁØ©ÈÅ∏ÁµêÊûú</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="lastUpdate">--</div>
                            <div class="stat-label">ÊúÄÂæåÊõ¥Êñ∞</div>
                        </div>
                    </div>
                </div>
                
                <div id="permitsContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>ËºâÂÖ•‰∏≠...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let companies = [];
        let allPermits = [];
        let filteredPermits = [];
        let selectedCompanies = new Set();
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            loadCompanies();
            loadPermits();
            
            // ÊêúÂ∞ãÊ°Ü‰∫ã‰ª∂
            document.getElementById('companySearch').addEventListener('input', filterCompanyList);
        });
        
        // ËºâÂÖ•ÂÖ¨Âè∏Ê∏ÖÂñÆ
        async function loadCompanies() {
            try {
                // ÈÄôË£°ÊáâË©≤Âæû API ËºâÂÖ•ÔºåÊö´ÊôÇ‰ΩøÁî®ÂÅáË≥áÊñô
                const response = await fetch('/api/baojia/companies');
                const data = await response.json();
                companies = data.companies || [];
            } catch (error) {
                // ‰ΩøÁî®È†êË®≠Ë≥áÊñô
                companies = [
                    "ÂØ∂‰Ω≥Âª∫Ë®≠", "ÂØ∂Ë™†Âª∫Ë®≠", "ÂØ∂Ê¨£Âª∫Ë®≠", "‰Ω≥ÁëûÂª∫Ë®≠", "‰Ω≥ÈôûÂª∫Ë®≠", "‰Ω≥Â±ïÂª∫Ë®≠",
                    "‰Ω≥Ê≥∞Âª∫Ë®≠", "‰Ω≥Áæ§Âª∫Ë®≠", "‰Ω≥ÊôüÂª∫Ë®≠", "‰Ω≥Á¶èÂª∫Ë®≠", "‰Ω≥ÊòÇÂª∫Ë®≠", "‰Ω≥ËåÇÂª∫Ë®≠",
                    "‰Ω≥È†ÜÂª∫Ë®≠", "‰Ω≥ÈãêÂª∫Ë®≠", "‰Ω≥ÈèµÂª∫Ë®≠", "‰Ω≥ÊòïÂª∫Ë®≠", "‰Ω≥ÁìöÂª∫Ë®≠", "‰Ω≥ÂèãÂª∫Ë®≠",
                    "‰Ω≥Â≥ªÂª∫Ë®≠", "ÂêàÈÅ†Âª∫Ë®≠", "ÂêàÂ∫∑Âª∫Ë®≠", "ÂêàÂòâÂª∫Ë®≠", "ÂêàÈôΩÂª∫Ë®≠", "ÂêàÊñ∞Âª∫Ë®≠",
                    "ÂêàË¨ôÂª∫Ë®≠", "ÂêàÁôªÂª∫Ë®≠", "ÂêàÁ°ØÂª∫Ë®≠", "ÂêàÈõÑÂª∫Ë®≠", "ÂêàÂ±ïÂª∫Ë®≠", "ÂêàÁ£äÂª∫Ë®≠",
                    "ÂíåÂ≥ªÂª∫Ë®≠", "ÂíåÁëûÂª∫Ë®≠", "ÂíåËÄÄÂª∫Ë®≠", "ÂíåÊØÖÂª∫Ë®≠", "ÂíåÁØâÂª∫Ë®≠", "ÂíåÂÆúÂª∫Ë®≠",
                    "ÂíåÊ¥≤Âª∫Ë®≠", "ÂíåÁ¥òÂª∫Ë®≠", "ÂíåÁôºÂª∫Ë®≠", "ÂíåÂ¢ÉÂª∫Ë®≠", "ÂãùÊó∫Âª∫Ë®≠", "ÂãùËèØÂª∫Ë®≠",
                    "ÂãùÈ∫óÂª∫Ë®≠", "ÂãùÁæéÂª∫Ë®≠", "ÂãùËààÂª∫Ë®≠", "ÂãùÁôºÂª∫Ë®≠", "ÁõäÊ¨£Âª∫Ë®≠", "ÁõäÂ±ïÂª∫Ë®≠",
                    "ÁõäÈ®èÂª∫Ë®≠", "ÁõäÁøîÂª∫Ë®≠", "È¥ªÁØâÂª∫Ë®≠", "È¥ªÁÅÉÂª∫Ë®≠", "È¥ªÂª£Âª∫Ë®≠", "È¥ªÊâøÂª∫Ë®≠",
                    "ÂçîÂíåÂª∫Ë®≠", "ÂçîÂãùÂª∫Ë®≠", "ÂçîÈñéÂª∫Ë®≠", "Ê´ªËä±Âª∫Ë®≠", "Ë™†‰Ω≥Âª∫Ë®≠", "ÂÇ≥‰Ω≥Âª∫Ë®≠",
                    "ËààÁØâÂª∫Ë®≠", "Èºé‰Ω≥Âª∫Ë®≠", "ÁØâÁ¶æÂª∫Ë®≠", "Ê≥ìÁëûÂª∫Ë®≠", "ÊÇÖ‰Ω≥Âª∫Ë®≠", "ÂÅâÁØâÂª∫Ë®≠",
                    "ÁöáÊôÆÂª∫Ë®≠", "ËÅö‰Ω≥Âª∫Ë®≠", "ÁßâÂíåÂª∫Ë®≠", "Êñ∞Â§ßÂª∫Ë®≠", "ÂØå‰æÜÂª∫Ë®≠", "ÊòïÊöâÂª∫Ë®≠",
                    "ÂºòÂ≥ªÂª∫Ë®≠", "Èµ¨Ë∫çÂª∫Ë®≠"
                ];
            }
            
            // È†êË®≠ÂÖ®ÈÅ∏
            selectedCompanies = new Set(companies);
            
            renderCompanyList();
            updateStats();
        }
        
        // Ê∏≤ÊüìÂÖ¨Âè∏Ê∏ÖÂñÆ
        function renderCompanyList() {
            const container = document.getElementById('companyList');
            const searchTerm = document.getElementById('companySearch').value.toLowerCase();
            
            const filteredCompanies = companies.filter(company => 
                company.toLowerCase().includes(searchTerm)
            );
            
            container.innerHTML = filteredCompanies.map(company => `
                <div class="checkbox-item">
                    <input type="checkbox" id="company_${company}" value="${company}" 
                           ${selectedCompanies.has(company) ? 'checked' : ''}
                           onchange="toggleCompany('${company}')">
                    <label for="company_${company}">${company}</label>
                </div>
            `).join('');
            
            document.getElementById('totalCompanies').textContent = companies.length;
        }
        
        // ÁØ©ÈÅ∏ÂÖ¨Âè∏Ê∏ÖÂñÆ
        function filterCompanyList() {
            renderCompanyList();
        }
        
        // ÂàáÊèõÂÖ¨Âè∏ÈÅ∏Êìá
        function toggleCompany(company) {
            if (selectedCompanies.has(company)) {
                selectedCompanies.delete(company);
            } else {
                selectedCompanies.add(company);
            }
        }
        
        // ÂÖ®ÈÅ∏
        function selectAll() {
            selectedCompanies = new Set(companies);
            renderCompanyList();
        }
        
        // ÂÖ®‰∏çÈÅ∏
        function deselectAll() {
            selectedCompanies.clear();
            renderCompanyList();
        }
        
        // Êñ∞Â¢ûÂÖ¨Âè∏
        async function addCompany() {
            const input = document.getElementById('newCompany');
            const companyName = input.value.trim();
            
            if (!companyName) {
                alert('Ë´ãËº∏ÂÖ•ÂÖ¨Âè∏ÂêçÁ®±');
                return;
            }
            
            if (companies.includes(companyName)) {
                alert('ÂÖ¨Âè∏Â∑≤Â≠òÂú®');
                return;
            }
            
            try {
                // ÈÄôË£°ÊáâË©≤ÂëºÂè´ API
                // const response = await fetch('/api/baojia/companies', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ company: companyName })
                // });
                
                companies.push(companyName);
                companies.sort();
                selectedCompanies.add(companyName);
                
                input.value = '';
                renderCompanyList();
                
                alert(`Â∑≤Êñ∞Â¢û: ${companyName}`);
            } catch (error) {
                alert('Êñ∞Â¢ûÂ§±Êïó: ' + error.message);
            }
        }
        
        // ËºâÂÖ•Âª∫ÁÖßË≥áÊñô
        async function loadPermits() {
            try {
                // ÈÄôË£°ÊáâË©≤Âæû API ËºâÂÖ•
                // const response = await fetch('/api/permits');
                // allPermits = await response.json();
                
                // Êö´ÊôÇ‰ΩøÁî®ÂÅáË≥áÊñô
                allPermits = generateMockPermits();
                
                updateStats();
                applyFilter();
            } catch (error) {
                console.error('ËºâÂÖ•Âª∫ÁÖßË≥áÊñôÂ§±Êïó:', error);
            }
        }
        
        // Â•óÁî®ÁØ©ÈÅ∏
        function applyFilter() {
            const filterEnabled = document.getElementById('filterToggle').checked;
            
            if (!filterEnabled || selectedCompanies.size === 0) {
                filteredPermits = [];
            } else {
                filteredPermits = allPermits.filter(permit => {
                    const applicant = permit.applicantName || '';
                    
                    // ÂÆåÂÖ®ÂåπÈÖç
                    if (selectedCompanies.has(applicant)) {
                        return true;
                    }
                    
                    // Êô∫ÊÖßÂåπÈÖç
                    for (const company of selectedCompanies) {
                        if (smartMatch(applicant, company)) {
                            return true;
                        }
                    }
                    
                    return false;
                });
            }
            
            renderPermits();
            updateStats();
        }
        
        // Êô∫ÊÖßÂåπÈÖç
        function smartMatch(applicant, company) {
            const suffixes = ['ËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏', 'ÊúâÈôêÂÖ¨Âè∏', 'Âª∫Ë®≠ËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏', 'ÁáüÈÄ†ËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏', 'ÁáüÈÄ†ÊúâÈôêÂÖ¨Âè∏'];
            
            let cleanApplicant = applicant;
            let cleanCompany = company;
            
            suffixes.forEach(suffix => {
                cleanApplicant = cleanApplicant.replace(suffix, '');
                cleanCompany = cleanCompany.replace(suffix, '');
            });
            
            cleanApplicant = cleanApplicant.trim();
            cleanCompany = cleanCompany.trim();
            
            return cleanApplicant === cleanCompany || 
                   cleanApplicant.includes(cleanCompany) || 
                   cleanCompany.includes(cleanApplicant);
        }
        
        // Ê∏≤ÊüìÂª∫ÁÖßÊ∏ÖÂñÆ
        function renderPermits() {
            const container = document.getElementById('permitsContent');
            
            if (filteredPermits.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑÂª∫ÁÖß</p>';
                return;
            }
            
            container.innerHTML = `
                <table class="permits-table">
                    <thead>
                        <tr>
                            <th>Âª∫ÁÖßËôüÁ¢º</th>
                            <th>Áî≥Ë´ã‰∫∫</th>
                            <th>Âª∫ÁØâÂú∞ÂùÄ</th>
                            <th>Ê®ìÂ±§</th>
                            <th>Ê£üÊï∏</th>
                            <th>Êà∂Êï∏</th>
                            <th>Á∏ΩÊ®ìÂú∞ÊùøÈù¢Á©ç</th>
                            <th>ÁôºÁÖßÊó•Êúü</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredPermits.map(permit => `
                            <tr>
                                <td>${permit.permitNumber || '-'}</td>
                                <td>${permit.applicantName || '-'}</td>
                                <td>${permit.constructionAddress || '-'}</td>
                                <td>${permit.floors || '-'}</td>
                                <td>${permit.buildings || '-'}</td>
                                <td>${permit.units || '-'}</td>
                                <td>${permit.totalFloorArea ? permit.totalFloorArea.toLocaleString() : '-'}</td>
                                <td>${permit.issueDate || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Êõ¥Êñ∞Áµ±Ë®àË≥áÊñô
        function updateStats() {
            document.getElementById('totalCompanies').textContent = companies.length;
            document.getElementById('totalPermits').textContent = allPermits.length;
            document.getElementById('filteredPermits').textContent = filteredPermits.length;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('zh-TW');
        }
        
        // Áî¢ÁîüÂÅáË≥áÊñôÔºàÊ∏¨Ë©¶Áî®Ôºâ
        function generateMockPermits() {
            const permits = [];
            const sampleCompanies = Array.from(companies);
            
            for (let i = 0; i < 100; i++) {
                const company = sampleCompanies[Math.floor(Math.random() * sampleCompanies.length)];
                const year = 113 + Math.floor(Math.random() * 2);
                
                permits.push({
                    permitNumber: `${year}‰∏≠ÈÉΩÂª∫Â≠óÁ¨¨${String(i + 1).padStart(5, '0')}Ëôü`,
                    applicantName: Math.random() > 0.3 ? company : company + 'ËÇ°‰ªΩÊúâÈôêÂÖ¨Âè∏',
                    constructionAddress: `Âè∞‰∏≠Â∏ÇË•øÂ±ØÂçÄÊüêÊüêË∑Ø${Math.floor(Math.random() * 999) + 1}Ëôü`,
                    floors: Math.floor(Math.random() * 20) + 1,
                    buildings: Math.floor(Math.random() * 5) + 1,
                    units: Math.floor(Math.random() * 100) + 1,
                    totalFloorArea: Math.floor(Math.random() * 10000) + 500,
                    issueDate: `2024-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`
                });
            }
            
            return permits;
        }
    </script>
</body>
</html>