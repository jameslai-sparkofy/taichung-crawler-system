#cloud-config
# OCI Instance è‡ªå‹•è¨­å®šè…³æœ¬

package_update: true
package_upgrade: true

packages:
  - python3
  - python3-pip
  - git
  - cronie

write_files:
  - path: /home/opc/setup_crawler.sh
    permissions: '0755'
    owner: opc:opc
    content: |
      #!/bin/bash
      
      # è¨­å®šçˆ¬èŸ²ç’°å¢ƒ
      cd /home/opc
      
      # å»ºç«‹å·¥ä½œç›®éŒ„
      mkdir -p taichung-building-crawler
      cd taichung-building-crawler
      
      # å¾ž Object Storage ä¸‹è¼‰çˆ¬èŸ²æª”æ¡ˆ
      export OCI_CLI_AUTH=instance_principal
      
      # ä¸‹è¼‰æ‰€æœ‰å¿…è¦æª”æ¡ˆ
      oci os object get -bn taichung-building-permits -ns nrsdi1rz5vl8 --name scripts/optimized-crawler-stable.py --file optimized-crawler-stable.py --auth instance_principal
      oci os object get -bn taichung-building-permits -ns nrsdi1rz5vl8 --name scripts/cron_daily_crawler_v3.py --file cron_daily_crawler_v3.py --auth instance_principal
      oci os object get -bn taichung-building-permits -ns nrsdi1rz5vl8 --name scripts/backup_current_data.py --file backup_current_data.py --auth instance_principal
      oci os object get -bn taichung-building-permits -ns nrsdi1rz5vl8 --name scripts/baojia_companies.json --file baojia_companies.json --auth instance_principal
      
      # å»ºç«‹æ¯æ—¥åŸ·è¡Œè…³æœ¬
      cat > daily_crawler_730am.sh << 'EOF'
      #!/bin/bash
      export OCI_CLI_AUTH=instance_principal
      export PATH="/home/opc/bin:$PATH"
      cd /home/opc/taichung-building-crawler
      
      echo "=========================================="
      echo "ðŸ• æ¯æ—¥çˆ¬èŸ²é–‹å§‹: $(date '+%Y-%m-%d %H:%M:%S')"
      echo "=========================================="
      
      python3 cron_daily_crawler_v3.py >> cron_daily_7am.log 2>&1
      
      if [ $? -eq 0 ]; then
          echo "âœ… çˆ¬èŸ²åŸ·è¡ŒæˆåŠŸ"
          python3 backup_current_data.py >> cron_daily_7am.log 2>&1
      else
          echo "âŒ çˆ¬èŸ²åŸ·è¡Œå¤±æ•—"
      fi
      
      echo "ðŸ• æ¯æ—¥çˆ¬èŸ²çµæŸ: $(date '+%Y-%m-%d %H:%M:%S')"
      echo ""
      EOF
      
      chmod +x daily_crawler_730am.sh
      
      # ä¿®æ”¹æª”æ¡ˆä¸­çš„è·¯å¾‘
      sed -i 's|/home/laija/bin/oci|oci|g' *.py
      sed -i 's|/mnt/c/claude code/å»ºç…§çˆ¬èŸ²/oci|/home/opc/taichung-building-crawler|g' *.py
      
      # å®‰è£ Python å¥—ä»¶
      pip3 install --user requests beautifulsoup4
      
      # è¨­å®š cron
      (crontab -l 2>/dev/null; echo "30 7 * * * /home/opc/taichung-building-crawler/daily_crawler_730am.sh") | crontab -
      
      echo "âœ… çˆ¬èŸ²ç’°å¢ƒè¨­å®šå®Œæˆï¼"

runcmd:
  - systemctl enable crond
  - systemctl start crond
  - su - opc -c '/home/opc/setup_crawler.sh'
  - echo "âœ… Cloud-init è¨­å®šå®Œæˆ" > /home/opc/setup_complete.txt