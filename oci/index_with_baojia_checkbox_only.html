<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…ƒå¿ƒå»ºæå»ºæ¡ˆæ•´ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #f8f9fa;
            line-height: 1.6;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card .subtitle {
            color: #888;
            font-size: 0.8em;
            margin-top: 5px;
        }
        
        .collapsible-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 15px 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
        }
        
        .section-header:hover {
            background: #e9ecef;
        }
        
        .section-header h2 {
            font-size: 1.2em;
            color: #333;
        }
        
        .section-header .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }
        
        .section-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .section-content {
            padding: 20px;
            display: none;
        }
        
        .section-content.expanded {
            display: block;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 0.9em;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a6fd8;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .log-entry {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .log-entry .date {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .log-entry .details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            font-size: 0.9em;
        }
        
        .log-entry .detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .log-entry .detail-label {
            color: #666;
            font-size: 0.8em;
        }
        
        .log-entry .detail-value {
            font-weight: 600;
            color: #333;
        }
        
        .main-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .main-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .main-header h2 {
            font-size: 1.3em;
            color: #333;
        }
        
        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
            font-size: 0.9em;
        }
        
        .ai-search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: 20px;
            position: relative;
        }
        
        .ai-search-input {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 25px;
            width: 300px;
            font-size: 0.9em;
            outline: none;
            transition: all 0.3s;
        }
        
        .ai-search-input:focus {
            width: 350px;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .ai-search-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .ai-search-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .ai-search-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .ai-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 5px;
            padding: 10px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .ai-search-loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .filter-results {
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            color: #666;
            font-size: 0.9em;
        }
        
        .permits-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table-header {
            background: #667eea;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table-header th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            user-select: none;
            border-right: 1px solid rgba(255,255,255,0.2);
        }
        
        .table-header th:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .table-header th.sortable::after {
            content: " â†•";
            opacity: 0.5;
        }
        
        .table-header th.sort-asc::after {
            content: " â†‘";
            opacity: 1;
        }
        
        .table-header th.sort-desc::after {
            content: " â†“";
            opacity: 1;
        }
        
        .table-header th.clickable {
            position: relative;
        }
        
        .table-header th.clickable::before {
            content: "ğŸ”";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7em;
            opacity: 0.7;
        }
        
        .table-row {
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }
        
        .table-row:hover {
            background: #f8f9fa;
        }
        
        .table-row:nth-child(even) {
            background: rgba(102, 126, 234, 0.02);
        }
        
        .table-row:nth-child(even):hover {
            background: #f8f9fa;
        }
        
        .table-row td {
            padding: 10px 8px;
            font-size: 0.85em;
            border-right: 1px solid #f0f0f0;
        }
        
        .permit-number {
            color: #667eea;
            font-weight: 600;
        }
        
        .applicant-cell {
            cursor: pointer;
            color: #495057;
        }
        
        .applicant-cell:hover {
            color: #667eea;
            text-decoration: underline;
        }
        
        .district-cell {
            cursor: pointer;
            color: #495057;
        }
        
        .district-cell:hover {
            color: #667eea;
            text-decoration: underline;
        }
        
        .number-cell {
            text-align: center;
            font-weight: 500;
        }
        
        .area-cell {
            text-align: right;
            font-weight: 500;
        }
        
        .date-cell {
            color: #666;
            font-size: 0.8em;
        }
        
        .btn-detail {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s ease;
        }
        
        .btn-detail:hover {
            background: #5a6fd8;
        }
        
        .btn-link {
            background: #28a745;
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8em;
            transition: background-color 0.3s ease;
            display: inline-block;
        }
        
        .btn-link:hover {
            background: #218838;
            color: white;
            text-decoration: none;
        }
        
        .dropdown-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            min-width: 150px;
        }
        
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9em;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
            margin: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 8px;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            position: relative;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.4em;
        }
        
        .close {
            color: white;
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
        }
        
        .close:hover {
            opacity: 1;
        }
        
        .permit-detail {
            padding: 20px;
        }
        
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .detail-table th,
        .detail-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }
        
        .detail-table th {
            background: #f8f9fa;
            font-weight: 600;
            width: 150px;
            color: #495057;
        }
        
        .detail-table td {
            background: white;
        }
        
        .detail-section-title {
            background: #667eea;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 12px;
            margin: 0;
        }
        
        /* æ¡Œæ©Ÿ/æ‰‹æ©Ÿé¡¯ç¤ºæ§åˆ¶ */
        .mobile-only {
            display: none;
        }
        
        .desktop-only {
            display: block;
        }
        
        /* æœå°‹å€åŸŸ */
        .search-section {
            padding: 20px;
            background: white;
        }
        
        /* æ¡Œæ©Ÿç‰ˆæœå°‹æ§åˆ¶ */
        .desktop-search-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .desktop-search-controls .search-input {
            flex: 0 1 250px;
            max-width: 250px;
        }
        
        .desktop-search-controls .ai-search-container {
            display: flex;
            gap: 10px;
            flex: 0 1 auto;
            max-width: 500px;
            position: relative;
        }
        
        /* æ»‘å‡ºå¼æœå°‹é¢æ¿ */
        .search-toggle {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .search-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1001;
            overflow-y: auto;
        }
        
        .search-panel.active {
            right: 0;
        }
        
        .search-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        
        .search-controls {
            padding: 20px;
        }
        
        .search-group {
            margin-bottom: 20px;
        }
        
        .search-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .search-group .ai-search-input {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .search-group .ai-search-btn {
            width: 100%;
        }
        
        .search-actions {
            margin-top: 20px;
            text-align: center;
        }
        
        /* åˆ†é æ¨£å¼ */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .pagination-info {
            color: #666;
            font-size: 0.9em;
        }
        
        .page-buttons {
            display: flex;
            gap: 5px;
        }
        
        .page-btn {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            background: white;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .page-btn:hover {
            background: #f8f9fa;
        }
        
        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .page-size-selector select {
            padding: 5px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        
        /* Mobile å„ªåŒ– */
        @media (max-width: 768px) {
            /* é¡¯ç¤ºæ§åˆ¶ */
            .mobile-only {
                display: block;
            }
            
            .desktop-only {
                display: none;
            }
            
            .desktop-search-controls {
                display: none;
            }
            
            .container {
                padding: 0;
                max-width: 100%;
            }
            
            .header {
                padding: 15px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.85em;
            }
            
            /* çµ±è¨ˆå¡ç‰‡æ”¹ç‚º 2x2 ç¶²æ ¼ */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 0 10px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-card h3 {
                font-size: 0.85em;
            }
            
            .stat-card .value {
                font-size: 1.8em;
            }
            
            .stat-card .subtitle {
                font-size: 0.75em;
            }
            
            /* æœå°‹å€åŸŸå„ªåŒ– */
            .search-section {
                padding: 15px;
            }
            
            .ai-search-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-input {
                width: 100%;
                font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
                padding: 12px;
            }
            
            .search-button {
                width: 100%;
                padding: 12px;
                font-size: 1em;
            }
            
            /* ç¯©é¸æ§åˆ¶é … */
            .filter-controls {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            .filter-controls select,
            .filter-controls input {
                width: 100%;
                font-size: 16px;
                padding: 10px;
            }
            
            /* è¡¨æ ¼å®¹å™¨å¯æ©«å‘æ»¾å‹• */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 15px 0;
                padding: 0;
            }
            
            .permits-table {
                min-width: 800px;
                font-size: 0.85em;
            }
            
            .permits-table th,
            .permits-table td {
                padding: 8px 5px;
                font-size: 0.85em;
            }
            
            /* é‡è¦æ¬„ä½ä¸éš±è—ï¼Œæ”¹ç”¨æ©«å‘æ»¾å‹• */
            .permits-table th,
            .permits-table td {
                display: table-cell !important;
            }
            
            /* å¯æ‘ºç–Šå€å¡Š */
            .collapsible-section {
                margin: 0 5px 15px 5px;
            }
            
            .section-header {
                padding: 12px;
                font-size: 0.9em;
            }
            
            .section-header h2 {
                font-size: 1.1em;
            }
            
            /* åŸ·è¡Œè¨˜éŒ„èª¿æ•´ */
            .log-entry {
                font-size: 0.85em;
                padding: 10px;
            }
            
            .details {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            /* ç›£æ§é¢æ¿æŒ‰éˆ• */
            .monitor-button {
                width: 100%;
                margin-top: 15px;
            }
            
            /* è¡¨æ ¼æ»¾å‹•æç¤º */
            .table-container::after {
                content: "â† å·¦å³æ»‘å‹•æŸ¥çœ‹æ›´å¤š â†’";
                display: block;
                text-align: center;
                color: #999;
                font-size: 0.8em;
                margin-top: 10px;
                padding: 5px;
            }
            
            /* æœå°‹é¢æ¿æ‰‹æ©Ÿç‰ˆ */
            .search-panel {
                width: 100%;
                right: -100%;
            }
            
            .search-toggle {
                position: static;
                transform: none;
                width: auto;
                padding: 8px 15px;
                font-size: 0.9em;
            }
            
            .main-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: nowrap;
                padding: 15px 10px !important;
            }
            
            .main-header h2 {
                font-size: 1.3em;
                margin: 0;
            }
            
            /* åˆ†é æ§åˆ¶æ‰‹æ©Ÿç‰ˆ */
            .pagination-controls {
                font-size: 0.85em;
                margin: 15px 0;
                padding: 10px 0;
            }
            
            .page-size-selector {
                margin-bottom: 10px;
            }
            
            /* ä¸»è¦å€å¡Š */
            .main-section {
                padding: 0;
            }
            
            /* æŒ‰éˆ•åœ¨æ‰‹æ©Ÿç‰ˆçš„èª¿æ•´ */
            .btn-detail, .btn-link {
                padding: 4px 8px;
                font-size: 0.8em;
                white-space: nowrap;
            }
            
            /* filter-results æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
            .filter-results {
                padding: 10px !important;
            }
            
            /* ä¿®æ­£ loading ç‹€æ…‹çš„ padding */
            .loading {
                padding: 20px 0 !important;
            }
            
            /* permitsList å®¹å™¨ä¸è¦æœ‰é¡å¤– padding */
            #permitsList {
                padding: 0 !important;
            }
            
            /* æ‰‹æ©Ÿç‰ˆæœå°‹æ§åˆ¶é …èª¿æ•´ */
            .search-panel .ai-search-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-panel .ai-search-input {
                width: 100%;
            }
            
            .search-panel .ai-search-btn {
                width: 100%;
                justify-content: center;
            }
            
            /* åœ¨æ‰‹æ©Ÿç‰ˆéš±è—æ¡Œé¢ç‰ˆçš„AIæœå°‹çµæœ */
            #aiSearchResultsDesktop {
                display: none !important;
            }
        }
        
        /* å°æ‰‹æ©Ÿå„ªåŒ– */
        @media (max-width: 375px) {
            .header h1 {
                font-size: 1.3em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .permits-table {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ï¸ å…ƒå¿ƒå»ºæå»ºæ¡ˆæ•´ç†</h1>
            <p>å³æ™‚ç›£æ§å°ä¸­å¸‚å»ºç¯‰åŸ·ç…§çˆ¬å–ç‹€æ…‹</p>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>ç¸½å»ºç…§æ•¸</h3>
                <div class="value" id="totalPermits">-</div>
                <div class="subtitle">ç´¯è¨ˆçˆ¬å–</div>
            </div>
            <div class="stat-card">
                <h3>æœ€æ–°å»ºæ¡ˆ</h3>
                <div class="value" id="latestPermit" style="font-size: 1.2em;">-</div>
                <div class="subtitle" id="latestPermitApplicant">-</div>
                <div class="subtitle" id="crawlStatus" style="margin-top: 5px; color: #28a745;">âœ… æ­£å¸¸</div>
            </div>
        </div>
        
        <div class="collapsible-section">
            <div class="section-header mobile-collapsed" onclick="toggleSection(this)">
                <h2>ğŸ“Š æœ€æ–°åŸ·è¡Œè¨˜éŒ„</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content" style="display: none;">
                <div id="latestLog" class="loading">è¼‰å…¥ä¸­...</div>
                <div style="margin-top: 20px; text-align: center;">
                    <a href="https://objectstorage.ap-tokyo-1.oraclecloud.com/n/nrsdi1rz5vl8/b/taichung-building-permits/o/monitor.html" 
                       target="_blank" 
                       class="monitor-button"
                       style="display: inline-block; padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; transition: background-color 0.3s;">
                        ğŸ–¥ï¸ ç›£æ§é¢æ¿
                    </a>
                </div>
            </div>
        </div>
        
        <div class="collapsible-section">
            <div class="section-header mobile-collapsed" onclick="toggleSection(this)">
                <h2>ğŸ” è³‡æ–™ç¯©é¸</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content" style="display: none;">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label for="yearFilter">å¹´ä»½</label>
                        <select id="yearFilter">
                            <option value="">å…¨éƒ¨å¹´ä»½</option>
                            <option value="114">114å¹´</option>
                            <option value="113">113å¹´</option>
                            <option value="112">112å¹´</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="startDate">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="filter-group">
                        <label for="endDate">çµæŸæ—¥æœŸ</label>
                        <input type="date" id="endDate">
                    </div>
                    <div class="filter-group">
                        <label for="districtFilter">è¡Œæ”¿å€</label>
                        <select id="districtFilter">
                            <option value="">å…¨éƒ¨å€åŸŸ</option>
                        </select>
                    </div>
                </div>
                <div class="filter-buttons">
                    <button class="btn btn-primary" onclick="applyFilters()">å¥—ç”¨ç¯©é¸</button>
                    <button class="btn btn-secondary" onclick="clearFilters()">æ¸…é™¤ç¯©é¸</button>
                </div>
            </div>
        </div>
        
        <div class="main-section">
            <div class="main-header">
                <h2>ğŸ“‘ å»ºç…§è³‡æ–™åˆ—è¡¨</h2>
                <button class="btn btn-primary search-toggle mobile-only" onclick="toggleSearchPanel()">
                    ğŸ” æœå°‹
                </button>
            </div>
            
            <!-- æ¡Œæ©Ÿç‰ˆæœå°‹å€åŸŸ -->
            <div class="search-section">
                <div class="desktop-search-controls">
                    <input type="text" class="search-input" id="applicantSearchDesktop" placeholder="æœå°‹èµ·é€ äºº..." onkeyup="searchApplicant(this.value, 'desktop')">
                    <button class="btn btn-secondary" onclick="clearSearch()">æ¸…é™¤</button>
                    
                    <div class="ai-search-container">
                        <input type="text" 
                               class="ai-search-input" 
                               id="aiSearchInputDesktop" 
                               placeholder="è‡ªç„¶èªè¨€æœå°‹ (ä¾‹: 113å¹´3æœˆå¾ŒåŒ—å±¯å€7æ¨“ä»¥ä¸Š)" 
                               onkeypress="if(event.key==='Enter') performAISearch('desktop')">
                        <button class="ai-search-btn" id="aiSearchBtnDesktop" onclick="performAISearch('desktop')">
                            <span>ğŸ¤–</span>
                            <span>æ™ºæ…§æœå°‹</span>
                        </button>
                        <div class="ai-search-results" id="aiSearchResultsDesktop"></div>
                    </div>
                    
                    <!-- å¯¶ä½³ç¯©é¸ -->
                    <div style="display: flex; align-items: center; margin-left: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-size: 1.1em;">
                            <input type="checkbox" id="baojiaFilter" onchange="toggleBaojiaFilter()" style="margin-right: 8px; transform: scale(1.2);">
                            <span>ğŸ—ï¸ å¯¶ä½³æ©Ÿæ§‹</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- æ‰‹æ©Ÿç‰ˆæ»‘å‡ºå¼æœå°‹é¢æ¿ -->
            <div class="search-panel mobile-only" id="searchPanel">
                <div class="search-panel-header">
                    <h3>æœå°‹é¸é …</h3>
                    <button class="close-btn" onclick="toggleSearchPanel()">âœ•</button>
                </div>
                <div class="search-controls">
                    <div class="search-group">
                        <label>èµ·é€ äººæœå°‹</label>
                        <input type="text" class="search-input" id="applicantSearchMobile" placeholder="æœå°‹èµ·é€ äºº..." onkeyup="searchApplicant(this.value, 'mobile')">
                    </div>
                    
                    <div class="search-group">
                        <label>æ™ºæ…§æœå°‹</label>
                        <input type="text" 
                               class="ai-search-input" 
                               id="aiSearchInputMobile" 
                               placeholder="è‡ªç„¶èªè¨€æœå°‹ (ä¾‹: 113å¹´3æœˆå¾ŒåŒ—å±¯å€7æ¨“ä»¥ä¸Š)" 
                               onkeypress="if(event.key==='Enter') performAISearch('mobile')">
                        <button class="ai-search-btn" id="aiSearchBtnMobile" onclick="performAISearch('mobile')">
                            <span>ğŸ¤–</span>
                            <span>æ™ºæ…§æœå°‹</span>
                        </button>
                        <div class="ai-search-results" id="aiSearchResultsMobile"></div>
                    </div>
                    
                    <div class="search-actions">
                        <button class="btn btn-secondary" onclick="clearAllSearches()">æ¸…é™¤å…¨éƒ¨</button>
                    </div>
                </div>
            </div>
            
            <div class="filter-results" id="filterResults"></div>
            
            <!-- åˆ†é æ§åˆ¶ -->
            <div class="pagination-controls" id="paginationTop"></div>
            
            <div id="permitsList" class="loading">è¼‰å…¥ä¸­...</div>
            
            <!-- åº•éƒ¨åˆ†é æ§åˆ¶ -->
            <div class="pagination-controls" id="paginationBottom"></div>
        </div>
    </div>
    
    <!-- è©³ç´°è³‡æ–™ Modal -->
    <div id="permitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal()">&times;</span>
                <h3 id="modalTitle">å»ºç…§è©³ç´°è³‡æ–™</h3>
            </div>
            <div id="permitDetail" class="permit-detail"></div>
        </div>
    </div>
    
    <script>
        // API URLs
        const PERMITS_API = 'https://objectstorage.ap-tokyo-1.oraclecloud.com/n/nrsdi1rz5vl8/b/taichung-building-permits/o/all_permits.json';
        const LOGS_API = 'https://objectstorage.ap-tokyo-1.oraclecloud.com/n/nrsdi1rz5vl8/b/taichung-building-permits/o/data/crawl-logs.json';
        
        let allPermits = [];
        let filteredPermits = [];
        let sortConfig = { key: 'permitNumber', direction: 'desc' };
        let currentPage = 1;
        let pageSize = 50;
        let searchPanelOpen = false;
        let districtDropdown = null;
        let baojiaCompanies = [];
        let baojiFilterActive = false;
        
        // åˆå§‹åŒ–
        async function init() {
            initCollapsibleSections();
            await loadBaojiaCompanies();
            await loadData();
            await loadLogs();
            populateDistrictFilter();
        }
        
        // åˆ‡æ›æ‘ºç–Šå€æ®µ
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const isCollapsed = header.classList.contains('collapsed') || header.classList.contains('mobile-collapsed');
            const icon = header.querySelector('.toggle-icon');
            
            if (isCollapsed) {
                header.classList.remove('collapsed');
                header.classList.remove('mobile-collapsed');
                content.style.display = 'block';
                icon.textContent = 'â–²';
            } else {
                header.classList.add('collapsed');
                content.style.display = 'none';
                icon.textContent = 'â–¼';
            }
        }
        
        // æª¢æ¸¬æ˜¯å¦ç‚ºæ‰‹æ©Ÿ
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // åˆå§‹åŒ–æ”¶åˆç‹€æ…‹
        function initCollapsibleSections() {
            if (isMobile()) {
                // æ‰‹æ©Ÿé è¨­æ”¶åˆ
                document.querySelectorAll('.mobile-collapsed').forEach(header => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.toggle-icon');
                    header.classList.add('collapsed');
                    content.style.display = 'none';
                    icon.textContent = 'â–¼';
                });
            } else {
                // æ¡Œé¢ç‰ˆé è¨­å±•é–‹
                document.querySelectorAll('.mobile-collapsed').forEach(header => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.toggle-icon');
                    header.classList.remove('collapsed');
                    header.classList.remove('mobile-collapsed');
                    content.style.display = 'block';
                    icon.textContent = 'â–²';
                });
            }
        }
        
        // è¼‰å…¥å»ºç…§è³‡æ–™
        async function loadData() {
            try {
                const response = await fetch(PERMITS_API);
                const data = await response.json();
                
                allPermits = data.permits || [];
                filteredPermits = [...allPermits];
                
                updateStats(data);
                sortPermits();
                renderPermits();
                
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                document.getElementById('permitsList').innerHTML = '<div class="error">è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
            }
        }
        
        // è¼‰å…¥åŸ·è¡Œè¨˜éŒ„
        async function loadLogs() {
            try {
                const response = await fetch(LOGS_API);
                const data = await response.json();
                const logs = data.logs || [];
                
                if (logs.length > 0) {
                    renderLatestLog(logs[0]);
                }
                
            } catch (error) {
                console.error('è¼‰å…¥è¨˜éŒ„å¤±æ•—:', error);
                document.getElementById('latestLog').innerHTML = '<div class="error">è¼‰å…¥è¨˜éŒ„å¤±æ•—</div>';
            }
        }
        
        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStats(data) {
            document.getElementById('totalPermits').textContent = data.totalCount || 0;
            
            // æœ€æ–°å»ºæ¡ˆ
            if (data.permits && data.permits.length > 0) {
                // æ‰¾å‡ºæœ€æ–°çš„å»ºæ¡ˆï¼ˆä¾indexKeyæ’åºï¼‰
                const latestPermit = data.permits.sort((a, b) => 
                    (b.indexKey || '').localeCompare(a.indexKey || '')
                )[0];
                
                if (latestPermit) {
                    document.getElementById('latestPermit').textContent = 
                        latestPermit.permitNumber || '-';
                    document.getElementById('latestPermitApplicant').textContent = 
                        (latestPermit.applicantName || latestPermit.applicant || '-').substring(0, 20) + 
                        (latestPermit.applicantName && latestPermit.applicantName.length > 20 ? '...' : '');
                }
            }
            
            // çˆ¬å–ç‹€æ…‹
            document.getElementById('crawlStatus').innerHTML = 'âœ… æ­£å¸¸';
            document.getElementById('crawlStatus').style.color = '#28a745';
        }
        
        // æ¸²æŸ“æœ€æ–°åŸ·è¡Œè¨˜éŒ„
        function renderLatestLog(log) {
            // è¨ˆç®—KEYç¯„åœ
            const keyRange = getKeyRangeFromLog(log);
            
            const logHtml = `
                <div class="log-entry">
                    <div class="date">ğŸ“… ${formatDate(log.date)} ${formatTime(log.startTime)}</div>
                    <div class="details">
                        <div class="detail-item">
                            <span class="detail-label">åŸ·è¡Œæ™‚é–“</span>
                            <span class="detail-value">${calculateDuration(log.startTime, log.endTime)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">çˆ¬å–ç¯„åœ</span>
                            <span class="detail-value">${keyRange}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ç¸½çˆ¬å–æ•¸</span>
                            <span class="detail-value">${log.totalCrawled}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">æ–°å¢è¨˜éŒ„</span>
                            <span class="detail-value">${log.newRecords}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">éŒ¯èª¤è¨˜éŒ„</span>
                            <span class="detail-value">${log.errorRecords}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">åŸ·è¡Œç‹€æ…‹</span>
                            <span class="detail-value" style="color: ${log.status === 'completed' ? '#28a745' : '#dc3545'}">
                                ${log.status === 'completed' ? 'æˆåŠŸ' : 'å¤±æ•—'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('latestLog').innerHTML = logHtml;
        }
        
        // å¾åŸ·è¡Œè¨˜éŒ„è¨ˆç®—KEYç¯„åœ
        function getKeyRangeFromLog(log) {
            if (log.yearStats) {
                const years = Object.keys(log.yearStats).sort().reverse();
                if (years.length > 0) {
                    const firstYear = years[years.length - 1];
                    const lastYear = years[0];
                    if (firstYear === lastYear) {
                        return `${firstYear}å¹´è³‡æ–™`;
                    } else {
                        return `${firstYear}-${lastYear}å¹´è³‡æ–™`;
                    }
                }
            }
            return 'ç¯„åœæœªçŸ¥';
        }
        
        // å¡«å……è¡Œæ”¿å€ç¯©é¸é¸é …
        function populateDistrictFilter() {
            const districts = [...new Set(allPermits
                .map(p => extractDistrict(p.siteAddress) || p.district)
                .filter(d => d)
            )].sort();
            
            const select = document.getElementById('districtFilter');
            select.innerHTML = '<option value="">å…¨éƒ¨å€åŸŸ</option>';
            
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                select.appendChild(option);
            });
        }
        
        // å¥—ç”¨ç¯©é¸
        function applyFilters() {
            const year = document.getElementById('yearFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const district = document.getElementById('districtFilter').value;
            const applicantSearchDesktop = document.getElementById('applicantSearchDesktop');
            const applicantSearchMobile = document.getElementById('applicantSearchMobile');
            const applicantSearch = (applicantSearchDesktop?.value || applicantSearchMobile?.value || '').toLowerCase();
            
            filteredPermits = allPermits.filter(permit => {
                // å¯¶ä½³ç¯©é¸
                if (baojiFilterActive && !isBaojiaCompany(permit.applicantName)) {
                    return false;
                }
                
                // å¹´ä»½ç¯©é¸
                if (year && permit.permitYear != year) return false;
                
                // æ—¥æœŸå€é–“ç¯©é¸
                if (startDate || endDate) {
                    const permitDate = permit.issueDate || permit.crawledAt?.split('T')[0];
                    if (!permitDate) return false;
                    if (startDate && permitDate < startDate) return false;
                    if (endDate && permitDate > endDate) return false;
                }
                
                // åœ°å€ç¯©é¸
                if (district) {
                    const permitDistrict = extractDistrict(permit.siteAddress) || permit.district;
                    if (permitDistrict !== district) return false;
                }
                
                // èµ·é€ äººæœå°‹
                if (applicantSearch) {
                    const applicantName = (permit.applicantName || '').toLowerCase();
                    if (!applicantName.includes(applicantSearch)) return false;
                }
                
                // AI æœå°‹æ¢ä»¶ç¯©é¸
                if (aiSearchConditions) {
                    // å¹´ä»½ç¯©é¸ï¼ˆAIæœå°‹å„ªå…ˆï¼‰
                    if (aiSearchConditions.year) {
                        const permitYear = parseInt(permit.indexKey.substring(0, 3));
                        if (permitYear !== aiSearchConditions.year) return false;
                    }
                    
                    // æœˆä»½ç¯©é¸
                    if (aiSearchConditions.month_from && permit.issueDate) {
                        const permitMonth = parseInt(permit.issueDate.split('-')[1]);
                        if (permitMonth < aiSearchConditions.month_from) return false;
                    }
                    
                    // è¡Œæ”¿å€ç¯©é¸ï¼ˆAIæœå°‹ï¼‰
                    if (aiSearchConditions.area || aiSearchConditions.areas) {
                        const permitArea = permit.administrativeArea || permit.area || permit.district || '';
                        
                        if (aiSearchConditions.areas) {
                            // å¤šå€‹å€åŸŸï¼Œåªè¦ç¬¦åˆå…¶ä¸­ä¸€å€‹å³å¯
                            if (!aiSearchConditions.areas.includes(permitArea)) return false;
                        } else if (aiSearchConditions.area) {
                            // å–®ä¸€å€åŸŸ
                            if (permitArea !== aiSearchConditions.area) return false;
                        }
                    }
                    
                    // æ¨“å±¤ç¯©é¸
                    if (aiSearchConditions.floors_min && permit.floors) {
                        if (permit.floors < aiSearchConditions.floors_min) return false;
                    }
                    
                    // æˆ¶æ•¸ç¯©é¸
                    if (aiSearchConditions.unit_count_min || aiSearchConditions.unit_count_max) {
                        const unitCount = parseInt(permit.unitCount) || 0;
                        if (aiSearchConditions.unit_count_min && unitCount < aiSearchConditions.unit_count_min) {
                            return false;
                        }
                        if (aiSearchConditions.unit_count_max && unitCount > aiSearchConditions.unit_count_max) {
                            return false;
                        }
                    }
                    
                    // æ£Ÿæ•¸ç¯©é¸
                    if (aiSearchConditions.building_count_min && permit.buildingCount) {
                        if (parseInt(permit.buildingCount) < aiSearchConditions.building_count_min) return false;
                    }
                    
                    // ç¸½æ¨“åœ°æ¿é¢ç©ç¯©é¸
                    if (aiSearchConditions.total_area_min && permit.totalFloorArea) {
                        if (parseFloat(permit.totalFloorArea) < aiSearchConditions.total_area_min) return false;
                    }
                    
                    // å»ºè¨­å…¬å¸/èµ·é€ äººç¯©é¸
                    if (aiSearchConditions.applicant_keyword) {
                        const applicant = permit.applicant || permit.applicantName || '';
                        if (!applicant.toLowerCase().includes(aiSearchConditions.applicant_keyword.toLowerCase())) {
                            return false;
                        }
                    }
                }
                
                return true;
            });
            
            currentPage = 1;
            sortPermits();
            renderPermits();
            updateFilterResults();
        }
        
        // æ¸…é™¤ç¯©é¸
        function clearFilters() {
            document.getElementById('yearFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('districtFilter').value = '';
            document.getElementById('applicantSearch').value = '';
            
            filteredPermits = [...allPermits];
            currentPage = 1;
            sortPermits();
            renderPermits();
            updateFilterResults();
        }
        
        // æœå°‹èµ·é€ äºº
        function searchApplicant(query, source = 'desktop') {
            // åŒæ­¥å…©å€‹è¼¸å…¥æ¡†çš„å€¼
            if (source === 'desktop') {
                const mobileInput = document.getElementById('applicantSearchMobile');
                if (mobileInput) mobileInput.value = query;
            } else {
                const desktopInput = document.getElementById('applicantSearchDesktop');
                if (desktopInput) desktopInput.value = query;
            }
            applyFilters();
        }
        
        // æ¸…é™¤æœå°‹
        function clearSearch() {
            document.getElementById('applicantSearchDesktop').value = '';
            document.getElementById('applicantSearchMobile').value = '';
            document.getElementById('aiSearchInputDesktop').value = '';
            document.getElementById('aiSearchInputMobile').value = '';
            document.getElementById('aiSearchResultsDesktop').innerHTML = '';
            document.getElementById('aiSearchResultsMobile').innerHTML = '';
            aiSearchConditions = null;
            applyFilters();
        }
        
        // Claude API æ™ºæ…§æœå°‹åŠŸèƒ½
        let aiSearchConditions = null;
        
        async function performAISearch(source = 'desktop') {
            const inputId = source === 'desktop' ? 'aiSearchInputDesktop' : 'aiSearchInputMobile';
            const btnId = source === 'desktop' ? 'aiSearchBtnDesktop' : 'aiSearchBtnMobile';
            const resultsId = source === 'desktop' ? 'aiSearchResultsDesktop' : 'aiSearchResultsMobile';
            
            const input = document.getElementById(inputId);
            const btn = document.getElementById(btnId);
            const query = input.value.trim();
            
            // åŒæ­¥å…©å€‹è¼¸å…¥æ¡†çš„å€¼
            const otherInputId = source === 'desktop' ? 'aiSearchInputMobile' : 'aiSearchInputDesktop';
            const otherInput = document.getElementById(otherInputId);
            if (otherInput) otherInput.value = query;
            
            // å¦‚æœå‹¾é¸å¯¶ä½³ç¯©é¸ï¼Œå…è¨±ç©ºç™½æœå°‹
            if (!query && !baojiFilterActive) {
                alert('è«‹è¼¸å…¥æœå°‹å…§å®¹');
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            btn.disabled = true;
            btn.innerHTML = '<span>ğŸ”„</span><span>æœå°‹ä¸­...</span>';
            
            try {
                // ä½¿ç”¨å¢å¼·ç‰ˆæœ¬åœ°è§£æå™¨ï¼ˆGPT API é¡åº¦ç”¨å®Œæ™‚çš„å‚™æ¡ˆï¼‰
                const useEnhancedParser = true;
                
                if (useEnhancedParser) {
                    // ä½¿ç”¨æ›´æ™ºæ…§çš„æœ¬åœ°è§£æ
                    const conditions = parseNaturalLanguageQueryEnhanced(query);
                    if (conditions) {
                        aiSearchConditions = conditions;
                        applyAISearchFilters();
                        showSearchConditions(conditions);
                        console.log('å¢å¼·è§£æçµæœ:', conditions);
                        return;
                    }
                }
                
                // ä½¿ç”¨æœ¬åœ°è§£æ
                const conditions = parseNaturalLanguageQuery(query);
                if (conditions) {
                    aiSearchConditions = conditions;
                    applyAISearchFilters();
                    showSearchConditions(conditions);
                }
            } catch (error) {
                console.error('æœå°‹éŒ¯èª¤:', error);
                alert('æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>ğŸ¤–</span><span>æ™ºæ…§æœå°‹</span>';
            }
        }
        
        // å¢å¼·ç‰ˆæœ¬åœ°è§£æå‡½æ•¸
        function parseNaturalLanguageQueryEnhanced(query) {
            const conditions = {};
            
            // æ¨™æº–åŒ–æŸ¥è©¢
            let normalizedQuery = query.toLowerCase();
            normalizedQuery = normalizedQuery.replace(/(\d+)([^\d\s])/g, '$1 $2');
            normalizedQuery = normalizedQuery.replace(/([^\d\s])(\d+)/g, '$1 $2');
            
            console.log('å¢å¼·è§£æ - æ¨™æº–åŒ–æŸ¥è©¢:', normalizedQuery);
            
            // æ™ºæ…§è§£æå¤šæ¢ä»¶çµ„åˆ
            // è™•ç† "113å¹´åœ¨å¤§é‡Œå€230æˆ¶ä»¥ä¸Š" é€™ç¨®è¤‡é›œæŸ¥è©¢
            
            // 1. å¹´ä»½è§£æï¼ˆæ”¯æ´å¤šç¨®æ ¼å¼ï¼‰
            const yearPatterns = [
                /(\d{3})\s*å¹´/,
                /æ°‘åœ‹\s*(\d{3})/,
                /ä»Šå¹´/,
                /å»å¹´/,
                /å‰å¹´/
            ];
            
            for (const pattern of yearPatterns) {
                const match = normalizedQuery.match(pattern);
                if (match) {
                    if (match[0] === 'ä»Šå¹´') {
                        conditions.year = 113;
                    } else if (match[0] === 'å»å¹´') {
                        conditions.year = 112;
                    } else if (match[0] === 'å‰å¹´') {
                        conditions.year = 111;
                    } else if (match[1]) {
                        conditions.year = parseInt(match[1]);
                    }
                    break;
                }
            }
            
            // 2. æœˆä»½è§£æï¼ˆæ”¯æ´ç¯„åœï¼‰
            const monthPatterns = [
                /(\d{1,2})\s*æœˆ\s*ä»¥å¾Œ/,
                /(\d{1,2})\s*æœˆ\s*ä¹‹å¾Œ/,
                /(\d{1,2})\s*æœˆ\s*èµ·/,
                /(\d{1,2})\s*[-~åˆ°è‡³]\s*(\d{1,2})\s*æœˆ/,
                /ç¬¬\s*([ä¸€äºŒä¸‰å››])\s*å­£/
            ];
            
            for (const pattern of monthPatterns) {
                const match = normalizedQuery.match(pattern);
                if (match) {
                    if (match[0].includes('å­£')) {
                        const quarterMap = {'ä¸€': 1, 'äºŒ': 4, 'ä¸‰': 7, 'å››': 10};
                        const quarter = quarterMap[match[1]];
                        if (quarter) {
                            conditions.month_from = quarter;
                            conditions.month_to = quarter + 2;
                        }
                    } else if (match[2]) {
                        conditions.month_from = parseInt(match[1]);
                        conditions.month_to = parseInt(match[2]);
                    } else if (match[1]) {
                        conditions.month_from = parseInt(match[1]);
                    }
                    break;
                }
            }
            
            // 3. è¡Œæ”¿å€è§£æï¼ˆæ›´æ™ºæ…§ï¼‰
            const areas = ['åŒ—å±¯å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'è¥¿å€', 'åŒ—å€', 'å—å€', 'æ±å€', 'ä¸­å€', 
                          'å¤ªå¹³å€', 'å¤§é‡Œå€', 'éœ§å³°å€', 'çƒæ—¥å€', 'è±åŸå€', 'æ½­å­å€', 'å¤§é›…å€', 
                          'ç¥å²¡å€', 'åé‡Œå€', 'æ±å‹¢å€', 'å’Œå¹³å€', 'æ–°ç¤¾å€', 'çŸ³å²¡å€', 'å¤–åŸ”å€', 
                          'å¤§å®‰å€', 'æ¸…æ°´å€', 'æ²™é¹¿å€', 'é¾äº•å€', 'æ¢§æ£²å€', 'å¤§è‚šå€', 'å¤§ç”²å€'];
            
            // å°‹æ‰¾è¡Œæ”¿å€ - æ”¯æ´å¤šå€‹å€åŸŸ
            let foundAreas = [];
            let remainingQuery = query;
            
            // 1. æ‰¾å®Œæ•´åŒ¹é…ï¼ˆå¦‚"åŒ—å±¯å€"ï¼‰
            for (const area of areas) {
                if (remainingQuery.includes(area)) {
                    foundAreas.push(area);
                    remainingQuery = remainingQuery.replace(area, ' '); // æ›¿æ›ç‚ºç©ºæ ¼é¿å…é‡è¤‡åŒ¹é…
                }
            }
            
            // 2. æ‰¾éƒ¨åˆ†åŒ¹é…ï¼ˆå¦‚"åŒ—å±¯"â†’"åŒ—å±¯å€"ï¼‰
            // æŒ‰é•·åº¦æ’åºï¼Œé•·çš„å„ªå…ˆåŒ¹é…
            const sortedAreas = [...areas].sort((a, b) => b.length - a.length);
            for (const area of sortedAreas) {
                const shortArea = area.replace('å€', '');
                if (shortArea.length > 1 && remainingQuery.includes(shortArea)) {
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“åœ¨foundAreasä¸­
                    if (!foundAreas.includes(area)) {
                        foundAreas.push(area);
                        remainingQuery = remainingQuery.replace(shortArea, ' ');
                    }
                }
            }
            
            // è¨­å®šå€åŸŸæ¢ä»¶
            if (foundAreas.length === 1) {
                conditions.area = foundAreas[0];
            } else if (foundAreas.length > 1) {
                conditions.areas = foundAreas; // å¤šå€‹å€åŸŸ
                // ä¸è¨­å®š areaï¼Œåªç”¨ areas
            }
            
            // 4. æˆ¶æ•¸è§£æï¼ˆæ”¯æ´å„ç¨®è¡¨é”ï¼‰
            const unitPatterns = [
                /(\d+)\s*[-~åˆ°è‡³]\s*(\d+)\s*æˆ¶/,
                /(\d+)\s*æˆ¶\s*ä»¥ä¸Š/,
                /(\d+)\s*æˆ¶\s*ä»¥ä¸‹/,
                /è¶…é\s*(\d+)\s*æˆ¶/,
                /å¤§æ–¼\s*(\d+)\s*æˆ¶/,
                /å°æ–¼\s*(\d+)\s*æˆ¶/
            ];
            
            for (const pattern of unitPatterns) {
                const match = normalizedQuery.match(pattern);
                if (match) {
                    if (match[0].includes('ä»¥ä¸Š') || match[0].includes('è¶…é') || match[0].includes('å¤§æ–¼')) {
                        conditions.unit_count_min = parseInt(match[1]);
                    } else if (match[0].includes('ä»¥ä¸‹') || match[0].includes('å°æ–¼')) {
                        conditions.unit_count_max = parseInt(match[1]);
                    } else if (match[2]) {
                        conditions.unit_count_min = parseInt(match[1]);
                        conditions.unit_count_max = parseInt(match[2]);
                    }
                    break;
                }
            }
            
            // 5. æ¨“å±¤è§£æ
            const floorPatterns = [
                /(\d+)\s*[-~åˆ°è‡³]\s*(\d+)\s*æ¨“/,
                /(\d+)\s*æ¨“\s*ä»¥ä¸Š/,
                /(\d+)\s*æ¨“\s*ä»¥ä¸‹/,
                /è¶…é\s*(\d+)\s*æ¨“/,
                /é«˜æ–¼\s*(\d+)\s*æ¨“/
            ];
            
            for (const pattern of floorPatterns) {
                const match = normalizedQuery.match(pattern);
                if (match) {
                    if (match[0].includes('ä»¥ä¸Š') || match[0].includes('è¶…é') || match[0].includes('é«˜æ–¼')) {
                        conditions.floors_min = parseInt(match[1]);
                    } else if (match[0].includes('ä»¥ä¸‹')) {
                        conditions.floors_max = parseInt(match[1]);
                    } else if (match[2]) {
                        conditions.floors_min = parseInt(match[1]);
                        conditions.floors_max = parseInt(match[2]);
                    }
                    break;
                }
            }
            
            // 6. å»ºè¨­å…¬å¸/èµ·é€ äººé—œéµå­—è§£æ
            const companyKeywords = [
                'å»ºè¨­', 'é–‹ç™¼', 'ç‡Ÿé€ ', 'å»ºç¯‰', 'åœ°ç”¢', 'ä¸å‹•ç”¢', 'å»ºæ¥­',
                'èˆˆæ¥­', 'å»ºå•†', 'å»ºè¨­å…¬å¸', 'é–‹ç™¼å…¬å¸', 'ç‡Ÿé€ å…¬å¸'
            ];
            
            // æ‰¾å‡ºå¯èƒ½çš„å…¬å¸åç¨±
            let companyName = '';
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ˜ç¢ºçš„å…¬å¸é—œéµå­—
            for (const keyword of companyKeywords) {
                if (normalizedQuery.includes(keyword)) {
                    // å˜—è©¦æå–å…¬å¸åç¨±
                    const regex = new RegExp(`([\\u4e00-\\u9fa5a-zA-Z\\d]{2,10})(${keyword})`, 'g');
                    const match = regex.exec(query);
                    if (match) {
                        companyName = match[1] + match[2];
                        break;
                    }
                }
            }
            
            // å¦‚æœæ²’æ‰¾åˆ°æ˜ç¢ºçš„å…¬å¸é—œéµå­—ï¼Œæª¢æŸ¥å¸¸è¦‹å»ºè¨­å…¬å¸åç¨±æ¨¡å¼
            if (!companyName) {
                const commonCompanies = [
                    'å¤ªå­', 'é é›„', 'èˆˆå¯Œç™¼', 'é•·è™¹', 'è¯å›º', 'åœ‹æ³°', 'å¯Œé‚¦', 'å®æ™®',
                    'æƒ å®‡', 'é †å¤©', 'è¯èš', 'ç²¾éŠ³', 'å¯¶è¼', 'é¾é‚¦', 'ä½³ç¦', 'é‰…è™¹',
                    'è±é‚‘', 'å¯¶ç’½', 'æ–°æ¥­', 'å…å°‡', 'å¤§åŸ', 'å®ç››', 'å¾·å®‰', 'æ«»èŠ±'
                ];
                
                for (const company of commonCompanies) {
                    if (query.includes(company)) {
                        companyName = company;
                        break;
                    }
                }
            }
            
            if (companyName) {
                conditions.applicant_keyword = companyName;
            }
            
            // 7. ç‰¹æ®Šé—œéµå­—è™•ç†
            if (normalizedQuery.includes('è±ªå®…')) {
                conditions.unit_count_max = conditions.unit_count_max || 100;
                conditions.floors_min = conditions.floors_min || 15;
                conditions.total_area_min = conditions.total_area_min || 10000;
            }
            
            if (normalizedQuery.includes('é€å¤©')) {
                conditions.floors_max = conditions.floors_max || 5;
                // é€å¤©å®šç¾©ï¼š5å±¤æ¨“ä»¥ä¸‹çš„æˆ¿å­ï¼ˆä¸é™åˆ¶æˆ¶æ•¸ï¼‰
            }
            
            if (normalizedQuery.includes('å¤§å‹') || normalizedQuery.includes('å¤§æ¨“')) {
                conditions.unit_count_min = conditions.unit_count_min || 50;
                conditions.floors_min = conditions.floors_min || 10;
            }
            
            console.log('å¢å¼·è§£æ - åŸå§‹æŸ¥è©¢:', query);
            console.log('å¢å¼·è§£æ - æ¨™æº–åŒ–æŸ¥è©¢:', normalizedQuery);
            console.log('å¢å¼·è§£æ - æ‰¾åˆ°çš„å€åŸŸ:', foundAreas);
            console.log('å¢å¼·è§£æ - æœ€çµ‚çµæœ:', conditions);
            return Object.keys(conditions).length > 0 ? conditions : null;
        }
        
        // æœ¬åœ°è§£æå‡½æ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
        function parseNaturalLanguageQuery(query) {
            const conditions = {};
            
            // å…ˆå°‡æŸ¥è©¢å­—ä¸²æ¨™æº–åŒ–ï¼ˆåŠ å…¥ç©ºæ ¼ä»¥ä¾¿è§£æï¼‰
            let normalizedQuery = query;
            // åœ¨æ•¸å­—å’Œä¸­æ–‡ä¹‹é–“åŠ å…¥ç©ºæ ¼
            normalizedQuery = normalizedQuery.replace(/(\d+)([^\d\s])/g, '$1 $2');
            normalizedQuery = normalizedQuery.replace(/([^\d\s])(\d+)/g, '$1 $2');
            
            console.log('æ¨™æº–åŒ–æŸ¥è©¢:', normalizedQuery);
            
            // è§£æå¹´ä»½
            const yearMatch = normalizedQuery.match(/(\d{3})\s*å¹´/);
            if (yearMatch) {
                conditions.year = parseInt(yearMatch[1]);
            }
            
            // è§£ææœˆä»½
            const monthMatch = normalizedQuery.match(/(\d{1,2})\s*æœˆ/);
            if (monthMatch) {
                conditions.month_from = parseInt(monthMatch[1]);
            }
            
            // è§£æè¡Œæ”¿å€ - ä½¿ç”¨æ›´ç²¾ç¢ºçš„åŒ¹é…
            const areas = ['åŒ—å±¯å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'è¥¿å€', 'åŒ—å€', 'å—å€', 'æ±å€', 'ä¸­å€', 
                          'å¤ªå¹³å€', 'å¤§é‡Œå€', 'éœ§å³°å€', 'çƒæ—¥å€', 'è±åŸå€', 'æ½­å­å€', 'å¤§é›…å€', 
                          'ç¥å²¡å€', 'åé‡Œå€', 'æ±å‹¢å€', 'å’Œå¹³å€', 'æ–°ç¤¾å€', 'çŸ³å²¡å€', 'å¤–åŸ”å€', 
                          'å¤§å®‰å€', 'æ¸…æ°´å€', 'æ²™é¹¿å€', 'é¾äº•å€', 'æ¢§æ£²å€', 'å¤§è‚šå€', 'å¤§ç”²å€'];
            
            // å°‹æ‰¾æ‰€æœ‰åŒ¹é…çš„è¡Œæ”¿å€ï¼ˆä»¥æœ€å¾Œä¸€å€‹ç‚ºæº–ï¼‰
            let foundArea = null;
            for (const area of areas) {
                if (query.includes(area)) {
                    foundArea = area;
                }
            }
            if (foundArea) {
                conditions.area = foundArea;
            }
            
            // è§£ææ¨“å±¤ - æ”¯æ´å€é–“
            const floorRangeMatch = normalizedQuery.match(/(\d+)\s*[-~åˆ°è‡³]\s*(\d+)\s*æ¨“/);
            const floorMinMatch = normalizedQuery.match(/(\d+)\s*æ¨“ä»¥ä¸Š/);
            const floorMaxMatch = normalizedQuery.match(/(\d+)\s*æ¨“ä»¥ä¸‹/);
            
            if (floorRangeMatch) {
                conditions.floors_min = parseInt(floorRangeMatch[1]);
                conditions.floors_max = parseInt(floorRangeMatch[2]);
            } else if (floorMinMatch) {
                conditions.floors_min = parseInt(floorMinMatch[1]);
            } else if (floorMaxMatch) {
                conditions.floors_max = parseInt(floorMaxMatch[1]);
            }
            
            // è§£ææˆ¶æ•¸ - æ”¯æ´å€é–“å’Œä»¥ä¸Š
            const unitRangeMatch = normalizedQuery.match(/(\d+)\s*[-~åˆ°è‡³]\s*(\d+)\s*æˆ¶/);
            const unitMinMatch = normalizedQuery.match(/(\d+)\s*æˆ¶ä»¥ä¸Š/);
            const unitMaxMatch = normalizedQuery.match(/(\d+)\s*æˆ¶ä»¥ä¸‹/);
            
            if (unitRangeMatch) {
                conditions.unit_count_min = parseInt(unitRangeMatch[1]);
                conditions.unit_count_max = parseInt(unitRangeMatch[2]);
            } else if (unitMinMatch) {
                conditions.unit_count_min = parseInt(unitMinMatch[1]);
            } else if (unitMaxMatch) {
                conditions.unit_count_max = parseInt(unitMaxMatch[1]);
            }
            
            // è§£ææ£Ÿæ•¸
            const buildingMatch = normalizedQuery.match(/(\d+)\s*æ£Ÿä»¥ä¸Š/);
            if (buildingMatch) {
                conditions.building_count_min = parseInt(buildingMatch[1]);
            }
            
            // è§£æç¸½æ¨“åœ°æ¿é¢ç©
            const areaMatch = normalizedQuery.match(/(\d+)\s*å¹³æ–¹å…¬å°ºä»¥ä¸Š|(\d+)\s*åªä»¥ä¸Š/);
            if (areaMatch) {
                if (normalizedQuery.includes('åª')) {
                    // 1åª = 3.306å¹³æ–¹å…¬å°º
                    conditions.total_area_min = parseInt(areaMatch[2]) * 3.306;
                } else {
                    conditions.total_area_min = parseInt(areaMatch[1]);
                }
            }
            
            console.log('è§£ææ¢ä»¶:', conditions);
            return conditions;
        }
        
        // å¥—ç”¨ AI æœå°‹ç¯©é¸
        function applyAISearchFilters() {
            console.log('AIæœå°‹æ¢ä»¶:', aiSearchConditions);
            // ç›´æ¥å‘¼å«ä¸»è¦çš„ç¯©é¸å‡½æ•¸ï¼Œå®ƒæœƒæª¢æŸ¥ aiSearchConditions
            applyFilters();
            
            // é™¤éŒ¯ï¼šé¡¯ç¤ºå‰5ç­†ç¬¦åˆçš„è³‡æ–™
            if (filteredPermits.length > 0) {
                console.log('ç¬¦åˆæ¢ä»¶çš„å‰5ç­†è³‡æ–™:');
                filteredPermits.slice(0, 5).forEach(p => {
                    console.log(`${p.permitNumber} - æˆ¶æ•¸: ${p.unitCount}`);
                });
            }
        }
        
        // é¡¯ç¤ºæœå°‹æ¢ä»¶
        function showSearchConditions(conditions) {
            let conditionText = 'æœå°‹æ¢ä»¶ï¼š';
            if (conditions.year) conditionText += `${conditions.year}å¹´ `;
            if (conditions.month_from) conditionText += `${conditions.month_from}æœˆä»¥å¾Œ `;
            if (conditions.areas) {
                conditionText += `${conditions.areas.join('ã€')} `;
            } else if (conditions.area) {
                conditionText += `${conditions.area} `;
            }
            if (conditions.applicant_keyword) conditionText += `å»ºè¨­å…¬å¸ï¼š${conditions.applicant_keyword} `;
            if (conditions.floors_min) conditionText += `${conditions.floors_min}æ¨“ä»¥ä¸Š `;
            if (conditions.unit_count_min && conditions.unit_count_max) {
                conditionText += `${conditions.unit_count_min}-${conditions.unit_count_max}æˆ¶ `;
            } else if (conditions.unit_count_min) {
                conditionText += `${conditions.unit_count_min}æˆ¶ä»¥ä¸Š `;
            } else if (conditions.unit_count_max) {
                conditionText += `${conditions.unit_count_max}æˆ¶ä»¥ä¸‹ `;
            }
            if (conditions.building_count_min) conditionText += `${conditions.building_count_min}æ£Ÿä»¥ä¸Š `;
            if (conditions.total_area_min) conditionText += `${Math.round(conditions.total_area_min)}å¹³æ–¹å…¬å°ºä»¥ä¸Š `;
            
            const filterResults = document.getElementById('filterResults');
            filterResults.innerHTML = `<strong>${conditionText}</strong><br>${filterResults.textContent}`;
        }
        
        // æ¸…é™¤ AI æœå°‹
        function clearAISearch() {
            document.getElementById('aiSearchInput').value = '';
            aiSearchConditions = null;
            applyFilters();
        }
        
        // æ›´æ–°ç¯©é¸çµæœ
        function updateFilterResults() {
            const total = allPermits.length;
            const filtered = filteredPermits.length;
            const resultText = filtered < total ? 
                `é¡¯ç¤º ${filtered} ç­†çµæœï¼ˆå…± ${total} ç­†ï¼‰` : 
                `é¡¯ç¤ºå…¨éƒ¨ ${total} ç­†çµæœ`;
            
            document.getElementById('filterResults').textContent = resultText;
        }
        
        // æ’åº
        function sortBy(key) {
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = key === 'permitNumber' ? 'desc' : 'asc';
            }
            
            sortPermits();
            renderPermits();
        }
        
        // åŸ·è¡Œæ’åº
        function sortPermits() {
            filteredPermits.sort((a, b) => {
                let aVal = a[sortConfig.key];
                let bVal = b[sortConfig.key];
                
                // è™•ç†å»ºç…§è™Ÿç¢¼æ’åº
                if (sortConfig.key === 'permitNumber') {
                    // æå–å¹´ä»½å’Œåºè™Ÿé€²è¡Œæ•¸å€¼æ’åº
                    const aMatch = (aVal || '').match(/(\d+)ä¸­.*ç¬¬(\d+)è™Ÿ/);
                    const bMatch = (bVal || '').match(/(\d+)ä¸­.*ç¬¬(\d+)è™Ÿ/);
                    
                    if (aMatch && bMatch) {
                        const aYear = parseInt(aMatch[1]);
                        const bYear = parseInt(bMatch[1]);
                        const aSeq = parseInt(aMatch[2]);
                        const bSeq = parseInt(bMatch[2]);
                        
                        if (aYear !== bYear) {
                            return sortConfig.direction === 'desc' ? bYear - aYear : aYear - bYear;
                        }
                        return sortConfig.direction === 'desc' ? bSeq - aSeq : aSeq - bSeq;
                    }
                }
                
                // è™•ç†æ•¸å€¼æ’åº
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return sortConfig.direction === 'desc' ? bVal - aVal : aVal - bVal;
                }
                
                // è™•ç†å­—ä¸²æ’åº
                aVal = String(aVal || '');
                bVal = String(bVal || '');
                
                if (sortConfig.direction === 'desc') {
                    return bVal.localeCompare(aVal, 'zh-TW');
                } else {
                    return aVal.localeCompare(bVal, 'zh-TW');
                }
            });
        }
        
        // æ¸²æŸ“å»ºç…§åˆ—è¡¨
        function renderPermits() {
            const container = document.getElementById('permitsList');
            
            if (filteredPermits.length === 0) {
                container.innerHTML = '<div class="error">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>';
                return;
            }
            
            const tableHtml = `
                <table class="permits-table">
                    <thead class="table-header">
                        <tr>
                            <th class="sortable" onclick="sortBy('permitNumber')" 
                                data-sort="${sortConfig.key === 'permitNumber' ? 'sort-' + sortConfig.direction : ''}">
                                å»ºé€ åŸ·ç…§è™Ÿç¢¼
                            </th>
                            <th class="clickable">èµ·é€ äºº</th>
                            <th>åœ°è™Ÿ</th>
                            <th class="clickable">è¡Œæ”¿å€</th>
                            <th class="sortable" onclick="sortBy('floors')"
                                data-sort="${sortConfig.key === 'floors' ? 'sort-' + sortConfig.direction : ''}">
                                æ¨“å±¤
                            </th>
                            <th class="sortable" onclick="sortBy('buildingCount')"
                                data-sort="${sortConfig.key === 'buildingCount' ? 'sort-' + sortConfig.direction : ''}">
                                æ£Ÿæ•¸
                            </th>
                            <th class="sortable" onclick="sortBy('unitCount')"
                                data-sort="${sortConfig.key === 'unitCount' ? 'sort-' + sortConfig.direction : ''}">
                                æˆ¶æ•¸
                            </th>
                            <th class="sortable" onclick="sortBy('totalFloorArea')"
                                data-sort="${sortConfig.key === 'totalFloorArea' ? 'sort-' + sortConfig.direction : ''}">
                                ç¸½æ¨“åœ°æ¿é¢ç©
                            </th>
                            <th class="sortable" onclick="sortBy('issueDate')"
                                data-sort="${sortConfig.key === 'issueDate' ? 'sort-' + sortConfig.direction : ''}">
                                ç™¼ç…§æ—¥æœŸ
                            </th>
                            <th style="text-align: center;">è©³æƒ…</th>
                            <th style="text-align: center;">é€£çµ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${renderTableRows()}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = `
                <div class="table-container">
                    ${tableHtml}
                </div>
            `;
            updateSortIcons();
            updatePagination();
        }
        
        // æ¸²æŸ“è¡¨æ ¼è¡Œ
        function renderTableRows() {
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            return filteredPermits.slice(startIndex, endIndex).map(permit => {
                const landNumber = extractLandNumber(permit.siteAddress);
                const district = extractDistrict(permit.siteAddress) || permit.district || '-';
                const permitNumber = permit.permitNumber || 'æœªçŸ¥';
                const totalFloorArea = permit.totalFloorArea ? 
                    (typeof permit.totalFloorArea === 'number' ? 
                        permit.totalFloorArea.toLocaleString() + ' mÂ²' : 
                        permit.totalFloorArea + ' mÂ²') : '-';
                const issueDate = permit.issueDate ? formatDate(permit.issueDate) : '-';
                
                const isBaojia = isBaojiaCompany(permit.applicantName);
                return `
                    <tr class="table-row">
                        <td class="permit-number">${permitNumber}</td>
                        <td class="applicant-cell" onclick="searchByApplicant('${(permit.applicantName || '').replace(/'/g, "\\'")}')">
                            ${permit.applicantName || '-'}
                            ${isBaojia ? '<span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">å¯¶ä½³</span>' : ''}
                        </td>
                        <td>${landNumber}</td>
                        <td class="district-cell" onclick="filterByDistrict('${district}')">${district}</td>
                        <td class="number-cell">${permit.floors || '-'}</td>
                        <td class="number-cell">${permit.buildingCount || '-'}</td>
                        <td class="number-cell">${permit.unitCount || '-'}</td>
                        <td class="area-cell">${totalFloorArea}</td>
                        <td class="date-cell">${issueDate}</td>
                        <td style="text-align: center;">
                            <div style="display: flex; flex-direction: column; gap: 5px; align-items: center;">
                                <a href="https://objectstorage.ap-tokyo-1.oraclecloud.com/n/nrsdi1rz5vl8/b/taichung-building-permits/o/html/${permit.indexKey}.html" 
                                   target="_blank" class="btn-detail">åŸæª”</a>
                                <button class="btn-detail" onclick="showPermitDetail('${permit.indexKey}')">è©³æƒ…</button>
                            </div>
                        </td>
                        <td style="text-align: center;">
                            <a href="https://mcgbm.taichung.gov.tw/bupic/pages/queryInfoAction.do?INDEX_KEY=${permit.indexKey}" 
                               target="_blank" class="btn-link">æ”¿åºœç¶²ç«™</a>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // æ›´æ–°æ’åºåœ–ç¤º
        function updateSortIcons() {
            document.querySelectorAll('.table-header th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.onclick && th.onclick.toString().includes(sortConfig.key)) {
                    th.classList.add('sort-' + sortConfig.direction);
                }
            });
        }
        
        // æŒ‰èµ·é€ äººæœå°‹
        function searchByApplicant(applicantName) {
            // æå–é—œéµå­—ï¼ˆå»é™¤å…¬å¸å¾Œç¶´ç­‰ï¼‰
            let keyword = applicantName;
            const companyKeywords = ['è‚¡ä»½æœ‰é™å…¬å¸', 'æœ‰é™å…¬å¸', 'è² è²¬äºº', 'ä»£è¡¨äºº', 'ç­‰å¦‚é™„è¡¨'];
            
            for (const ck of companyKeywords) {
                if (keyword.includes(ck)) {
                    const parts = keyword.split(ck);
                    keyword = parts[0].trim();
                    break;
                }
            }
            
            // é€²ä¸€æ­¥æå–æ ¸å¿ƒåç¨±
            if (keyword.includes(':')) {
                keyword = keyword.split(':')[1].trim();
            }
            
            // åªå–å‰å¹¾å€‹å­—
            if (keyword.length > 4) {
                keyword = keyword.substring(0, 4);
            }
            
            document.getElementById('applicantSearch').value = keyword;
            applyFilters();
        }
        
        // æŒ‰è¡Œæ”¿å€ç¯©é¸
        function filterByDistrict(district) {
            document.getElementById('districtFilter').value = district;
            applyFilters();
        }
        
        // é¡¯ç¤ºå»ºç…§è©³ç´°è³‡æ–™
        function showPermitDetail(indexKey) {
            const permit = allPermits.find(p => p.indexKey === indexKey);
            if (!permit) return;
            
            document.getElementById('modalTitle').textContent = permit.permitNumber || 'å»ºç…§è©³ç´°è³‡æ–™';
            
            const detailHtml = `
                <table class="detail-table">
                    <tr>
                        <td colspan="2" class="detail-section-title">ğŸ“‹ åŸºæœ¬è³‡è¨Š</td>
                    </tr>
                    <tr>
                        <th>å»ºé€ åŸ·ç…§è™Ÿç¢¼</th>
                        <td>${permit.permitNumber || '-'}</td>
                    </tr>
                    <tr>
                        <th>ç´¢å¼•ç¢¼</th>
                        <td>${permit.indexKey}</td>
                    </tr>
                    <tr>
                        <th>å¹´ä»½</th>
                        <td>${permit.permitYear}å¹´</td>
                    </tr>
                    <tr>
                        <th>ç™¼ç…§æ—¥æœŸ</th>
                        <td>${permit.issueDate ? formatDate(permit.issueDate) : '-'}</td>
                    </tr>
                </table>
                
                <table class="detail-table">
                    <tr>
                        <td colspan="2" class="detail-section-title">ğŸ‘· ç›¸é—œäººå“¡</td>
                    </tr>
                    <tr>
                        <th>èµ·é€ äºº</th>
                        <td>${permit.applicantName || '-'}</td>
                    </tr>
                    <tr>
                        <th>è¨­è¨ˆäºº</th>
                        <td>${permit.designerName || '-'}</td>
                    </tr>
                    <tr>
                        <th>è¨­è¨ˆäº‹å‹™æ‰€</th>
                        <td>${permit.designerCompany || '-'}</td>
                    </tr>
                    <tr>
                        <th>ç›£é€ äºº</th>
                        <td>${permit.supervisorName || '-'}</td>
                    </tr>
                    <tr>
                        <th>ç›£é€ äº‹å‹™æ‰€</th>
                        <td>${permit.supervisorCompany || '-'}</td>
                    </tr>
                    <tr>
                        <th>æ‰¿é€ äºº</th>
                        <td>${permit.contractorName || '-'}</td>
                    </tr>
                    <tr>
                        <th>ç‡Ÿé€ å» å•†</th>
                        <td>${permit.contractorCompany || '-'}</td>
                    </tr>
                    <tr>
                        <th>å°ˆä»»å·¥ç¨‹äººå“¡</th>
                        <td>${permit.engineerName || '-'}</td>
                    </tr>
                </table>
                
                <table class="detail-table">
                    <tr>
                        <td colspan="2" class="detail-section-title">ğŸ“ åŸºåœ°è³‡è¨Š</td>
                    </tr>
                    <tr>
                        <th>åŸºåœ°åœ°å€</th>
                        <td>${permit.siteAddress || '-'}</td>
                    </tr>
                    <tr>
                        <th>åœ°è™Ÿ</th>
                        <td>${permit.landNumber || extractLandNumber(permit.siteAddress) || '-'}</td>
                    </tr>
                    <tr>
                        <th>è¡Œæ”¿å€</th>
                        <td>${permit.district || extractDistrict(permit.siteAddress) || '-'}</td>
                    </tr>
                    <tr>
                        <th>ä½¿ç”¨åˆ†å€</th>
                        <td>${permit.siteZone || '-'}</td>
                    </tr>
                    <tr>
                        <th>åŸºåœ°é¢ç©</th>
                        <td>${permit.siteArea ? permit.siteArea + ' mÂ²' : '-'}</td>
                    </tr>
                </table>
                
                <table class="detail-table">
                    <tr>
                        <td colspan="2" class="detail-section-title">ğŸ¢ å»ºç¯‰è³‡è¨Š</td>
                    </tr>
                    <tr>
                        <th>å±¤æ£Ÿæˆ¶æ•¸</th>
                        <td>${permit.floorInfo || '-'}</td>
                    </tr>
                    <tr>
                        <th>æ¨“å±¤</th>
                        <td>${permit.floors || '-'}</td>
                    </tr>
                    <tr>
                        <th>æ£Ÿæ•¸</th>
                        <td>${permit.buildingCount || '-'}</td>
                    </tr>
                    <tr>
                        <th>æˆ¶æ•¸</th>
                        <td>${permit.unitCount || '-'}</td>
                    </tr>
                    <tr>
                        <th>ç¸½æ¨“åœ°æ¿é¢ç©</th>
                        <td>${permit.totalFloorArea ? (typeof permit.totalFloorArea === 'number' ? permit.totalFloorArea.toLocaleString() + ' mÂ²' : permit.totalFloorArea + ' mÂ²') : '-'}</td>
                    </tr>
                </table>
                
                <table class="detail-table">
                    <tr>
                        <td colspan="2" class="detail-section-title">ğŸ”— ç›¸é—œé€£çµ</td>
                    </tr>
                    <tr>
                        <th>æ”¿åºœç¶²ç«™é€£çµ</th>
                        <td>
                            <a href="https://mcgbm.taichung.gov.tw/bupic/pages/queryInfoAction.do?INDEX_KEY=${permit.indexKey}" 
                               target="_blank" class="btn-link">
                                æŸ¥çœ‹åŸå§‹è³‡æ–™
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th>çˆ¬å–æ™‚é–“</th>
                        <td>${formatDateTime(permit.crawledAt)}</td>
                    </tr>
                </table>
            `;
            
            document.getElementById('permitDetail').innerHTML = detailHtml;
            document.getElementById('permitModal').style.display = 'block';
        }
        
        // é—œé–‰ Modal
        function closeModal() {
            document.getElementById('permitModal').style.display = 'none';
        }
        
        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('permitModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-TW');
        }
        
        // è¼”åŠ©å‡½æ•¸
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-TW');
        }
        
        function formatTime(timeStr) {
            const date = new Date(timeStr);
            return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        }
        
        function calculateDuration(start, end) {
            const startTime = new Date(start);
            const endTime = new Date(end);
            const duration = (endTime - startTime) / 1000;
            
            if (duration < 60) {
                return `${duration.toFixed(1)} ç§’`;
            } else {
                const minutes = Math.floor(duration / 60);
                const seconds = (duration % 60).toFixed(0);
                return `${minutes} åˆ† ${seconds} ç§’`;
            }
        }
        
        // å¾åœ°å€ä¸­æå–åœ°è™Ÿ
        function extractLandNumber(address) {
            if (!address) return '-';
            
            const fullMatch = address.match(/(è‡ºä¸­å¸‚[^å€]+å€[^æ®µ]+æ®µ[\d-]+åœ°è™Ÿ)/);
            if (fullMatch) return fullMatch[1];
            
            const simpleMatch = address.match(/([^å¸‚å€]+æ®µ[\d-]+åœ°è™Ÿ)/);
            if (simpleMatch) return simpleMatch[1];
            
            return address.length > 30 ? address.substring(0, 30) + '...' : address;
        }
        
        // å¾åœ°å€ä¸­æå–è¡Œæ”¿å€
        function extractDistrict(address) {
            if (!address) return null;
            
            const fullMatch = address.match(/è‡ºä¸­å¸‚([^å€]+å€)/);
            if (fullMatch) return fullMatch[1];
            
            const districts = [
                'è¥¿å±¯å€', 'å—å±¯å€', 'åŒ—å±¯å€', 'è¥¿å€', 'å—å€', 'åŒ—å€', 'æ±å€', 'ä¸­å€',
                'å¤ªå¹³å€', 'å¤§é‡Œå€', 'çƒæ—¥å€', 'è±åŸå€', 'éœ§å³°å€', 'å¤§é›…å€', 'æ½­å­å€',
                'åé‡Œå€', 'ç¥å²¡å€', 'æ¢§æ£²å€', 'æ¸…æ°´å€', 'å¤§ç”²å€', 'å¤–åŸ”å€', 'å¤§å®‰å€',
                'æ²™é¹¿å€', 'é¾äº•å€', 'å¤§è‚šå€', 'æ–°ç¤¾å€', 'çŸ³å²¡å€', 'æ±å‹¢å€', 'å’Œå¹³å€'
            ];
            
            for (const district of districts) {
                if (address.includes(district)) return district;
            }
            return null;
        }
        
        // é–‹å§‹è¼‰å…¥è³‡æ–™
        // æ›´æ–°åˆ†é æ§åˆ¶
        function updatePagination() {
            const totalPages = Math.ceil(filteredPermits.length / pageSize);
            const paginationHtml = createPaginationHtml(totalPages);
            
            document.getElementById('paginationTop').innerHTML = paginationHtml;
            document.getElementById('paginationBottom').innerHTML = paginationHtml;
        }
        
        // å‰µå»ºåˆ†é HTML
        function createPaginationHtml(totalPages) {
            if (totalPages <= 1) return '';
            
            let html = '<div class="pagination-controls">';
            
            // åˆ†é è³‡è¨Š
            html += `<div class="pagination-info">
                å…± ${filteredPermits.length} ç­†ï¼Œç¬¬ ${currentPage} / ${totalPages} é 
            </div>`;
            
            // åˆ†é æŒ‰éˆ•
            html += '<div class="page-buttons">';
            
            // ä¸Šä¸€é 
            html += `<button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                ä¸Šä¸€é 
            </button>`;
            
            // é ç¢¼æŒ‰éˆ•
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
            
            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }
            
            if (startPage > 1) {
                html += '<button class="page-btn" onclick="changePage(1)">1</button>';
                if (startPage > 2) html += '<span style="margin: 0 5px;">...</span>';
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += '<span style="margin: 0 5px;">...</span>';
                html += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }
            
            // ä¸‹ä¸€é 
            html += `<button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                ä¸‹ä¸€é 
            </button>`;
            
            html += '</div>';
            
            // æ¯é ç­†æ•¸é¸æ“‡å™¨
            html += `<div class="page-size-selector">
                <label>æ¯é é¡¯ç¤ºï¼š</label>
                <select onchange="changePageSize(this.value)">
                    <option value="50" ${pageSize === 50 ? 'selected' : ''}>50ç­†</option>
                    <option value="100" ${pageSize === 100 ? 'selected' : ''}>100ç­†</option>
                    <option value="200" ${pageSize === 200 ? 'selected' : ''}>200ç­†</option>
                </select>
            </div>`;
            
            html += '</div>';
            
            return html;
        }
        
        // åˆ‡æ›é é¢
        function changePage(page) {
            const totalPages = Math.ceil(filteredPermits.length / pageSize);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderPermits();
            
            // æ²å‹•åˆ°è¡¨æ ¼é ‚éƒ¨
            document.querySelector('.main-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // æ”¹è®Šæ¯é ç­†æ•¸
        function changePageSize(size) {
            pageSize = parseInt(size);
            currentPage = 1;
            renderPermits();
        }
        
        // æœå°‹é¢æ¿åˆ‡æ›
        function toggleSearchPanel() {
            const panel = document.getElementById('searchPanel');
            searchPanelOpen = !searchPanelOpen;
            
            if (searchPanelOpen) {
                panel.classList.add('active');
            } else {
                panel.classList.remove('active');
            }
        }
        
        // è¼‰å…¥å¯¶ä½³å…¬å¸åå–®
        async function loadBaojiaCompanies() {
            try {
                const response = await fetch('https://objectstorage.ap-tokyo-1.oraclecloud.com/n/nrsdi1rz5vl8/b/taichung-building-permits/o/baojia_companies.json');
                const data = await response.json();
                baojiaCompanies = data.companies || [];
                console.log('è¼‰å…¥å¯¶ä½³å…¬å¸åå–®:', baojiaCompanies.length, 'å®¶');
            } catch (error) {
                console.error('è¼‰å…¥å¯¶ä½³å…¬å¸åå–®å¤±æ•—:', error);
                baojiaCompanies = [];
            }
        }
        
        // åˆ‡æ›å¯¶ä½³ç¯©é¸
        function toggleBaojiaFilter() {
            baojiFilterActive = document.getElementById('baojiaFilter').checked;
            applyFilters();
        }
        
        // å¯¶ä½³æ™ºæ…§åŒ¹é…
        function isBaojiaCompany(applicantName) {
            if (!applicantName || baojiaCompanies.length === 0) return false;
            
            // æ¸…ç†ç”³è«‹äººåç¨±
            let cleanName = applicantName
                .replace(/è² è²¬äºº[ï¼š:].+$/g, '')
                .replace(/ä»£è¡¨äºº[ï¼š:].+$/g, '')
                .replace(/\s+ç­‰å¦‚é™„è¡¨$/g, '')
                .trim();
            
            // å…¬å¸åç¨±å¾Œç¶´
            const suffixes = ['è‚¡ä»½æœ‰é™å…¬å¸', 'æœ‰é™å…¬å¸', 'å»ºè¨­è‚¡ä»½æœ‰é™å…¬å¸', 'ç‡Ÿé€ è‚¡ä»½æœ‰é™å…¬å¸', 'ç‡Ÿé€ æœ‰é™å…¬å¸'];
            
            return baojiaCompanies.some(company => {
                // å®Œå…¨åŒ¹é…
                if (cleanName === company) return true;
                
                // ç§»é™¤å¾Œç¶´æ¯”å°
                let companyBase = company;
                let nameBase = cleanName;
                
                for (const suffix of suffixes) {
                    companyBase = companyBase.replace(suffix, '');
                    nameBase = nameBase.replace(suffix, '');
                }
                
                if (companyBase === nameBase) return true;
                
                // åŒ…å«é—œä¿‚æª¢æŸ¥
                if (cleanName.includes(company) || company.includes(cleanName)) return true;
                
                return false;
            });
        }
        
        // æ¸…é™¤æ‰€æœ‰æœå°‹
        function clearAllSearches() {
            document.getElementById('applicantSearchDesktop').value = '';
            document.getElementById('applicantSearchMobile').value = '';
            document.getElementById('aiSearchInputDesktop').value = '';
            document.getElementById('aiSearchInputMobile').value = '';
            document.getElementById('aiSearchResultsDesktop').innerHTML = '';
            document.getElementById('aiSearchResultsMobile').innerHTML = '';
            aiSearchConditions = null;
            clearFilters();
            toggleSearchPanel();
        }
        
        init();
        
        // æ¯5åˆ†é˜è‡ªå‹•æ›´æ–°ä¸€æ¬¡
        setInterval(init, 5 * 60 * 1000);
    </script>
</body>
</html>